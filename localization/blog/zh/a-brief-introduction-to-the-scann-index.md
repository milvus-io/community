---
id: a-brief-introduction-to-the-scann-index.md
title: ScaNN 索引简介
author: Jack Li
date: 2026-01-21T00:00:00.000Z
cover: assets.zilliz.com/scann_cover_9a9787ee8a.png
tag: Engineering
recommend: false
publishToMedium: true
tags: 'Milvus, vector database'
meta_keywords: 'ScaNN index, IVFPQ, vector similarity search, ANN, Milvus'
meta_title: |
  A Brief Introduction to the ScaNN Index and How It Improves IVFPQ
desc: >-
  深入探讨 ScaNN 索引：它如何通过分数感知量化和 4 位 FastScan 改进 IVFPQ，以及 Milvus 在 Cohere1M
  数据集上的基准测试结果。
origin: 'https://milvus.io/blog/a-brief-introduction-to-the-scann-index.md'
---
<p><a href="https://github.com/google-research/google-research/tree/master/scann">ScaNN</a>是谷歌对大规模向量搜索中一个常见挑战的回应：<strong>如何提高查询吞吐量并减少内存使用量，同时又不对结果质量造成不可接受的影响。</strong>从概念上讲，ScaNN 以经典的 IVF+PQ 方法为起点--粗略聚类加上积极的乘积量化--但在此基础上进行了两项重要创新，从而有意义地改变了性能前沿：</p>
<ul>
<li><p><strong>分数感知量化目标</strong>能更好地保留真实邻域的相对排序，即使在重度压缩的情况下也能提高排序质量。</p></li>
<li><p><strong>FastScan</strong>是一种 SIMD 优化的 4 位 PQ 查找路径，通过将更多工作保留在 CPU 寄存器中，减少了传统的内存负载瓶颈。</p></li>
</ul>
<p>在实践中，当你可以用一些召回率来换取高 QPS 和更小的内存占用（通常将向量压缩到原始大小的约 1/16）时，比如在对召回不敏感的推荐工作负载中，FastScan 是一个不错的选择。</p>
<p>在这篇文章中，我们将以 IVFPQ 为基准，重新审视 IVFPQ，探讨 ScaNN 在此基础上引入的关键优化，并以实验结果作为总结，从而将讨论建立在实测性能的基础之上。</p>
<h2 id="IVFPQ-Recap" class="common-anchor-header">IVFPQ 回顾<button data-href="#IVFPQ-Recap" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>ScaNN 是谷歌在 2020 年提出的，该论文报告称，在 GloVe 数据集上，ScaNN 的性能比 HNSW 提高了 3 倍。详情可参阅<a href="https://arxiv.org/pdf/1908.10396.pdf">原始论文</a>和<a href="https://github.com/google-research/google-research/tree/master/scann">开源实现</a>。</p>
<p>在介绍 ScaNN 之前，我们先简单回顾一下 IVFPQ，因为 ScaNN 也是建立在相同的整体框架之上的。</p>
<p><strong>IVFPQ</strong> 是<strong>Inverted File with Product Quantization</strong> 的缩写，是一种用于在高维向量数据库中进行高效、大规模近似近邻（ANN）搜索的算法。它是一种混合方法，结合了<strong>倒置文件索引（IVF）</strong>和<strong>乘积量化（PQ）</strong>这两种技术，以平衡搜索速度、内存使用和准确性。</p>
<h3 id="How-IVFPQ-Works" class="common-anchor-header">IVFPQ 如何工作</h3><p>该过程包括索引和搜索两个主要步骤：</p>
<ul>
<li>IVF 层：向量被聚类为<code translate="no">nlist</code> 反向列表（簇）。查询时，只访问簇的子集（<code translate="no">nprobe</code> ），以权衡召回率和延迟/吞吐量。</li>
</ul>
<p>
  <span class="img-wrapper">
    <img translate="no" src="https://assets.zilliz.com/ivf1_5e3d29c392.png" alt="" class="doc-image" id="" />
    <span></span>
  </span>
</p>
<ul>
<li>PQ 层：在每个访问过的簇内，每个 D 维向量被分成 m 个子向量，每个子向量的维数为 (D/m)。通过将每个子向量分配给其子编码本中最近的中心点，对每个子向量进行量化。如果子代码簿有 256 个中心点，那么每个子向量都可以用<code translate="no">uint8</code> 代码（[0, 255] 中的 ID）来表示。</li>
</ul>
<p>
  <span class="img-wrapper">
    <img translate="no" src="https://assets.zilliz.com/pq2_6695c9cc6f.png" alt="" class="doc-image" id="" />
    <span></span>
  </span>
</p>
<p>这样，距离计算就可以改写为子向量上的总和：</p>
<p><strong>D(q, X) = D(q, u0) + D(q, u1) + D(q, u2) + ... + D(q, un)</strong></p>
<p><strong>= L（q，id1） + L（q，id2） + L（q，id3） + ... + L（q，idn）</strong></p>
<p>这里，L 表示查找表。在查询时，查找表被构建，记录查询和每个量化子向量之间的距离。所有后续的距离计算都转换为查找表，然后求和。</p>
<p>
  <span class="img-wrapper">
    <img translate="no" src="https://assets.zilliz.com/query_vector3_75d47bdd53.png" alt="" class="doc-image" id="" />
    <span></span>
  </span>
</p>
<p>例如，对于分割成 32 个子向量（每个子向量 4 维）的 128 维向量，如果每个子向量都用<code translate="no">uint8</code> ID 编码，则每个向量的存储成本将从 (128 x 4) 字节降至 (32 x 1) 字节，减少了 1/16。</p>
<h2 id="ScaNN-Optimizations-Based-on-IVFPQ" class="common-anchor-header">基于 IVFPQ 的 ScaNN 优化<button data-href="#ScaNN-Optimizations-Based-on-IVFPQ" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>总之，ScaNN 在两个方面改进了 IVFPQ：</p>
<ol>
<li><p>量化：ScaNN 提出的目标不仅仅是用最接近的 k-means 中心点替换每个子向量（即最小化重构误差）。</p></li>
<li><p>查找效率：ScaNN 通过 SIMD 友好型 FastScan 路径加速基于 LUT 的搜索，这种搜索通常会占用内存。</p></li>
</ol>
<h3 id="Score-aware-Quantization-Loss" class="common-anchor-header">分数感知量化损失</h3><p>ScaNN 采用的量化方法不同于传统的 PQ--这就是上图所示的与 PQ 不同的过程。在传统的 PQ 量化中，每个向量需要通过计算与不同量化中心的距离，并选择距离最小的一个量化中心，从而分配到一个量化中心。其目标主要是最小化用<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><annotation encoding="application/x-tex"> xi~\tilde{x_i}</annotation></semantics></math></span></span></span> 替换<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><annotation encoding="application/x-tex">xix_i</annotation></semantics></math></span></span></span><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span> x<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span><span class="vlist-s">i</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>时引入的量化误差<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em;"></span> x</span></span></span></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight"> </span></span></span></span><span class="vlist-s">i</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span></span></span><span class="vlist-s">~</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>:<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mn>∑i=1n∥xi-x~i∥2\sum_{i=1}^n</mn></msup></mrow><annotation encoding="application/x-tex">\| x_i - \tilde{x}_i</annotation></semantics></math></span></span></span>\<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><annotation encoding="application/x-tex">|^2</annotation></semantics></math></span></span></span><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">i=1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3.05em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">n</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">∥x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span></span></span></span></span></span></span></span></span> i<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span></span>-</span></span></span><span class="mspace" style="margin-right:0.2222em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span> <span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span> x</span></span></span></span></span></span></span></span></span></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span> ~</span></span></span></span></span></span></span></span></span></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span><span class="vlist-s">i</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord">∥</span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span> 2.</p>
<p>ScaNN 对这一过程进行了修改。首先，它引入了损失的概念，与上述量化误差略有不同。这种损失指的是两个向量之间的实际距离与使用量化方法计算出的近似距离之间的误差。ScaNN 主要针对内积（IP）距离。IP 距离误差和查询向量分布可用公式描述：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover><mi>Eq∑n</mi></mover><msup><mrow><mrow><mo fence="true">(</mo><mi>⟨q</mi><mo separator="true">,</mo></mrow><mrow><mi>xi⟩-⟨q</mi><mo separator="true">,</mo><msub><mi>x~i</mi></msub></mrow><mo fence="true">⟩)</mo></mrow></msup><msup><mrow><mi>2=Eq∑n⟨q</mi><mo separator="true">,</mo></mrow><mn>xi-x~i⟩2\mathbb{E}_q</mn></msup></mrow><annotation encoding="application/x-tex">\sum^n\left(\left\langle q, x_i\right\rangle-\left\langle q、</annotation></semantics></math></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="pstrut" style="height:3em;"></span><span class="pstrut" style="height:3em;"></span><span class="pstrut" style="height:2.7em;"></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="pstrut" style="height:2.7em;"></span>\<span class="katex-display"><span class="katex">tilde{x}_i\rightrangle\right<span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><annotation encoding="application/x-tex">)^2=\mathbb{E}_q \sum^n\left\langle q, x_i-\tilde{x}_i\rightrangle^2</annotation></semantics></math></span></span></span><span class="strut" style="height:2.2014em;vertical-align:-0.55em;"></span><span class="katex-display"><span class="katex">E</span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">q</span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span><span class="katex-display"><span class="katex"></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"></span></span><span class="pstrut" style="height:3.05em;"></span> <span class="katex-display"><span class="katex">∑</span></span><span class="pstrut" style="height:3.05em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">n</span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.55em;"><span></span></span></span><span class="katex-display"><span class="katex"></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="minner"><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">⟨q</span></span><span class="minner"><span class="mpunct">,</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex">x</span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="minner"><span class="minner"><span class="minner"><span class="mclose delimcenter" style="top:0em;">⟩</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">-</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="minner"><span class="mord mathnormal" style="margin-right:0.03588em;">⟨q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3em;"></span> <span class="katex-display"><span class="katex">x</span></span><span class="pstrut" style="height:3em;"></span><span class="katex-display"><span class="katex">~</span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="minner"><span class="minner"><span class="mclose delimcenter" style="top:0em;"> ⟩)</span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex">2</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="katex-display"><span class="katex">=</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="katex-display"><span class="katex"></span></span><span class="strut" style="height:2.2014em;vertical-align:-0.55em;"></span> <span class="katex-display"><span class="katex">E</span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">q</span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span><span class="katex-display"><span class="katex"></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"></span></span><span class="pstrut" style="height:3.05em;"></span> <span class="katex-display"><span class="katex">∑</span></span><span class="pstrut" style="height:3.05em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">n</span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.55em;"><span></span></span></span><span class="katex-display"><span class="katex"></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="minner"><span class="minner"><span class="mord mathnormal" style="margin-right:0.03588em;">⟨q</span><span class="mpunct">,</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex">x</span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="minner"><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.954em;"><span style="top:-3.2029em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">i</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>如果假设查询向量 q 是各向同性的，则<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><msup><mi>qqT</mi></msup><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">=cI\mathbb{E｝[qq^T] = cI</annotation></semantics></math></span></span></span><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"></span> E<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">qq</span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span> T<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span></span></span></span></span>=<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">cI</span></span></span></span></span>，其中<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><annotation encoding="application/x-tex">II</annotation></semantics></math></span></span></span><span class="strut" style="height:0.6833em;"></span> I 是标识矩阵。因此，损失函数可以简化为</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msup><mrow><mi>∑i=1nEq⟨q</mi><mo separator="true">,</mo></mrow><mn>xi-xi~⟩2</mn></msup></mrow></mstyle></mtd></mtr></mtable></semantics></math></span></span></span><mrow></mrow><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>=∑i=1nE</mi></msub><msup>q<mrow><mo fence="true">(</mo><mover accent="true"><mo>xi-xi~</mo></mover><mo fence="true">)</mo></mrow></msup><msup><mi>TqqT</mi></msup><mrow><mo fence="true">(</mo></mrow><msup><mrow><msub><mi>xi-xi~</mi></msub></mrow></msup><mrow><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr></mtable></semantics></math></span></span></span><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics></semantics></math></span></span></span><mrow></mrow> <span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><annotation encoding="application/x-tex">=c∑i=1n∥xi-xi~∥2begin{aligned}\sum_{i=1}^n \mathbb{E}_q\left\langle q, x_i-\tilde{x_i}\rightrangle^2 &amp;\=sum_{i=1}^n \mathbb{E}_qleft(x_i-\tilde{x_i}\right)^T q q^T\left(x_i-\tilde{x_i}\right) \ &amp;=c \sum_{i=1}^n\left\|x_i-\tilde{x_i}\right\|^2 \end{aligned}</annotation></semantics></math></span></span></span><span class="strut" style="height:6.4581em;vertical-align:-2.9791em;"></span><span class="katex-display"><span class="katex"></span></span><span class="pstrut" style="height:3.6514em;"></span> <span class="katex-display"><span class="katex"></span></span><span class="pstrut" style="height:3.05em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">i=1</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3.05em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-3.05em;"><span><span class="mop op-symbol large-op">∑</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3.05em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">n</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span><span class="katex-display"><span class="katex"></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex">E</span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">q</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span><span class="katex-display"><span class="katex"></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord mathnormal" style="margin-right:0.03588em;">⟨</span></span></span><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">q</span></span></span></span></span><span class="minner"><span class="minner"><span class="mpunct">、</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="pstrut" style="height:2.7em;"></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="pstrut" style="height:3em;"></span><span class="pstrut" style="height:2.7em;"></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="pstrut" style="height:3em;"></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="pstrut" style="height:3.6514em;"></span><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="pstrut" style="height:3.05em;"></span><span class="pstrut" style="height:3.05em;"></span><span class="pstrut" style="height:3.05em;"></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="pstrut" style="height:2.7em;"></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="pstrut" style="height:3em;"></span><span class="pstrut" style="height:2.7em;"></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="pstrut" style="height:3em;"></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="pstrut" style="height:2.7em;"></span>x<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="minner"><span class="minner"><span class="mbin">-</span><span class="mspace" style="margin-right:0.2222em;"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable">x</span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"></span></span></span></span></span></span><span class="pstrut" style="height:3em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">~</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="minner"><span class="minner"><span class="mclose delimcenter" style="top:0em;">⟩</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable">2</span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.6514em;"></span><span class="mord"></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s"></span></span><span class="vlist-r"><span class="vlist" style="height:2.9791em;"><span></span></span></span> </span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="pstrut" style="height:3.6514em;"></span><span class="mord"><span class="mrel"> </span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable">=</span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"></span></span></span></span></span></span><span class="pstrut" style="height:3.05em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">i=1</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3.05em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-3.05em;"><span><span class="mop op-symbol large-op">∑</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3.05em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">n</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable">E</span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">q</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="mord mathnormal">(x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="minner"><span class="minner"><span class="mbin">-</span><span class="mspace" style="margin-right:0.2222em;"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable">x</span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"></span></span></span></span></span></span><span class="pstrut" style="height:3em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">~</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable">)</span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable">T</span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.4791em;"><span style="top:-5.4791em;"><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">qq</span></span></span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">xml-ph-0034@deepl.in</span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:2.9791em;"><span></span></span></span></p>
<p>ScaNN 认为这个损失函数不是最优的，因为对于给定的查询，离查询更近的数据点更重要。减少这些数据点的量化误差对结果更为重要。因此，ScaNN 提出了一种分数感知量化损失：</p>
<p>\ell/left<span class="katex-error" title="ParseError: KaTeX parse error: Invalid delimiter type &#x27;color&#x27;" style="color:#cc0000">(x_i, \tilde{x}\i, w\right)=\mathbb{E}\_{q \sim \mathcal{Q}}/left/[w/left(\left/langle q, x\_i\right\rangle\right)\left/langle q, x\_i-\tilde{x}\_i\rightrangle^2\right]</span>.</p>
<p>这里，w 代表权重。</p>
<p>
  <span class="img-wrapper">
    <img translate="no" src="https://assets.zilliz.com/score_aware_quantization_loss_d9d36223c2.png" alt="" class="doc-image" id="" />
    <span></span>
  </span>
</p>
<p>然而，这带来了一个挑战：这个权重是查询感知的，这意味着我们只有在知道查询后才能计算这个损失。因此，我们需要某些假设和转换来消除对 q 的显式依赖，从而在离线阶段构建索引。</p>
<p>本文将误差<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><annotation encoding="application/x-tex">xi-xi~x_i-\tilde{x_i}</annotation></semantics></math></span></span></span><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span> x<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span><span class="vlist-s">i</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">-</span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em;"></span> <span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span> x</span></span></span></span></span></span></span></span></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span><span class="vlist-s">i</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span></span></span><span class="vlist-s">~</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>分解为平行于<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><annotation encoding="application/x-tex">xix_i</annotation></semantics></math></span></span></span><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span> x<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span><span class="vlist-s">i</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> 和垂直于<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>xix_i</mi></msub></mrow></semantics></math></span></span></span> x<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span> 的两个部分，并对平行部分施加较大的惩罚。损耗表示为</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi mathvariant="normal">ℓ</mi><mrow><mo fence="true">(</mo><msub><mi>xi</mi></msub><mo separator="true">,</mo><msub><mi>x~i</mi></msub></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo separator="true">,</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mi>w</mi><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr></mtable></semantics></math></span></span></span><mrow></mrow><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi mathvariant="normal">=h∥</mi></msub><mrow><mo fence="true">(</mo><mi>w</mi><mo separator="true">,</mo><mrow><mo fence="true">∥xi∥</mo></mrow><mo fence="true">)</mo></mrow><msup><mrow><msub><mi mathvariant="normal">∥r∥</mi></msub><mrow><mo fence="true">(</mo><msub><mi>xi</mi></msub><mo separator="true">,</mo><msub><mi>x~i</mi></msub><mo fence="true">)</mo></mrow></mrow></msup><msub><mo lspace="0em" rspace="0em">∥2+h⊥</mo></msub><mrow><mo fence="true">(</mo><mi>w</mi><mo separator="true">,</mo><mrow><mo fence="true">∥xi∥</mo></mrow><mo fence="true">)</mo></mrow><msup><mrow><msub><mo lspace="0em" rspace="0em">∥r⊥</mo></msub><mrow><mo fence="true">(</mo><msub><mi>xi</mi></msub><mo separator="true">,</mo><msub><mi>x~i</mi></msub><mo fence="true">)</mo></mrow></mrow></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">∥2begin{aligned}\ell（left（x_i, tilde{x}_i, w\right) &amp;=h_{\|}\left(w,\left\|x_i\right\|\right)\left\|r_{\|}\left(x_i, \tilde{x}_i\right)\right\|^2 +h_{\perp}\left(w,\left\|x_i\right\|\right)\left\|r_{\perp}\left(x_i,</annotation></semantics></math></span>\<span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><annotation encoding="application/x-tex">tilde{x}_i\right)\right\|^2 \end{aligned}</annotation></semantics></math></span></span></span><span class="strut" style="height:1.714em;vertical-align:-0.607em;"></span><span class="katex-display"><span class="katex"></span></span><span class="pstrut" style="height:3.054em;"></span> <span class="katex-display"><span class="katex">ℓ</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mord"><span class="mord mathnormal">(x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex">,</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex"></span></span><span class="pstrut" style="height:3em;"></span> <span class="katex-display"><span class="katex">x</span></span><span class="pstrut" style="height:3em;"></span><span class="katex-display"><span class="katex">~</span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex">,</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex">w<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">)</span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.607em;"><span></span></span></span><span class="katex-display"><span class="katex"></span></span><span class="pstrut" style="height:3.054em;"></span> <span class="katex-display"><span class="katex"></span></span><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span> <span class="katex-display"><span class="katex">=</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="katex-display"><span class="katex">h</span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">∥</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span><span class="katex-display"><span class="katex"></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mord mathnormal" style="margin-right:0.02691em;">(w</span><span class="mpunct">.、</span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mord mathnormal"><span class="pstrut" style="height:3em;"></span><span class="pstrut" style="height:2.7em;"></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="pstrut" style="height:2.7em;"></span>∥x</span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="mord mathnormal"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mclose delimcenter" style="top:0em;">∥</span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist" style="height:0.85em;"><span style="top:-2.85em;"><span class="pstrut" style="height:3.2em;"></span><span style="width:0.556em;height:1.200em;"><svg translate="no" xmlns="http://www.w3.org/2000/svg" width="0.556em" height="1.200em" viewBox="0 0 556 1200"><path d="M145 15 v585 v0 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M188 15 H145 v585 v0 v585 h43z
M367 15 v585 v0 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M410 15 H367 v585 v0 v585 h43z"/></svg></span></span></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;"> </span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">∥</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="mord mathnormal">(x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">,</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">x</span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">~</span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">)</span></span></span></span></span></span></span></span></span><span class="vlist" style="height:0.85em;"><span style="top:-2.85em;"><span class="pstrut" style="height:3.2em;"></span><span style="width:0.556em;height:1.200em;"><svg translate="no" xmlns="http://www.w3.org/2000/svg" width="0.556em" height="1.200em" viewBox="0 0 556 1200"><path d="M145 15 v585 v0 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M188 15 H145 v585 v0 v585 h43z
M367 15 v585 v0 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M410 15 H367 v585 v0 v585 h43z"/></svg></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s"></span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span> </span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.054em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"> </span></span></span></span></span></span></span></span></span></span></span>2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">+</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">h</span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mopen delimcenter" style="top:0em;"> ⊥</span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mord mathnormal" style="margin-right:0.02691em;">(w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mord"><span class="mord mathnormal">∥x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">∥<span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="minner"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">∥r</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">⊥</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="mord mathnormal">(x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">,</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3em;"></span><span class="vlist-s"> </span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span><span class="vlist-r"><span class="vlist" style="height:0.607em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>为什么要对平行分量施加更大的惩罚？</p>
<p>首先，如果 x 是 q1 的近邻，那么 x 的方向与 q1 相似，所以 x 的平行分量也可以近似认为与 q1 平行，这个平行分量会增加误差。</p>
<p>
  <span class="img-wrapper">
    <img translate="no" src="https://assets.zilliz.com/quantizer_f0e39762a4.png" alt="" class="doc-image" id="" />
    <span></span>
  </span>
</p>
<p>由于分析是基于 IP 度量的，因此 ScaNN 将量化误差分解为平行分量和垂直分量后，只有平行分量会影响结果，因此应使用较大的惩罚项。因此，损失函数可以重写如下：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi mathvariant="normal">ℓ</mi><mrow><mo fence="true">(</mo><msub><mi>xi</mi></msub><mo separator="true">,</mo><msub><mi>x~i</mi></msub><mo separator="true">,</mo><mi>w</mi><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr></mtable></semantics></math></span></span></span><mrow></mrow><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi mathvariant="normal">=h∥</mi></msub><mrow><mo fence="true">(</mo><mi>w</mi><mo separator="true">,</mo><mrow><mo fence="true">∥xi∥</mo></mrow><mo fence="true">)</mo></mrow><msup><mrow><msub><mi mathvariant="normal">∥r∥</mi></msub><mrow><mo fence="true">(</mo><msub><mi>xi</mi></msub><mo separator="true">,</mo><msub><mi>x~i</mi></msub><mo fence="true">)</mo></mrow></mrow></msup><msub><mo lspace="0em" rspace="0em">∥2+h⊥</mo></msub><mrow><mo fence="true">(</mo><mi>w</mi><mo separator="true">,</mo><mrow><mo fence="true">∥xi∥</mo></mrow><mo fence="true">)</mo></mrow><msup><mrow><msub><mo lspace="0em" rspace="0em">∥r⊥</mo></msub><mrow><mo fence="true">(</mo><msub><mi>xi</mi></msub><mo separator="true">,</mo><msub><mi>x~i</mi></msub><mo fence="true">)</mo></mrow></mrow></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">∥2begin{aligned}\ell（left（x_i, tilde{x}_i, w\right) &amp;=h_{\|}\left(w,\left\|x_i\right\|\right)\left\|r_{\|}\left(x_i, \tilde{x}_i\right)\right\|^2 +h_{\perp}\left(w,\left\|x_i\right\|\right)\left\|r_{\perp}\left(x_i,</annotation></semantics></math></span>\<span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><annotation encoding="application/x-tex">tilde{x}_i\right)\right\|^2 \end{aligned}</annotation></semantics></math></span></span></span><span class="strut" style="height:1.714em;vertical-align:-0.607em;"></span><span class="katex-display"><span class="katex"></span></span><span class="pstrut" style="height:3.054em;"></span> <span class="katex-display"><span class="katex">ℓ</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mord"><span class="mord mathnormal">(x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex">,</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex"></span></span><span class="pstrut" style="height:3em;"></span> <span class="katex-display"><span class="katex">x</span></span><span class="pstrut" style="height:3em;"></span><span class="katex-display"><span class="katex">~</span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex">,</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex">w<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">)</span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.607em;"><span></span></span></span><span class="katex-display"><span class="katex"></span></span><span class="pstrut" style="height:3.054em;"></span> <span class="katex-display"><span class="katex"></span></span><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span> <span class="katex-display"><span class="katex">=</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="katex-display"><span class="katex">h</span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">∥</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span><span class="katex-display"><span class="katex"></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mord mathnormal" style="margin-right:0.02691em;">(w</span><span class="mpunct">.、</span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mord mathnormal"><span class="pstrut" style="height:3em;"></span><span class="pstrut" style="height:2.7em;"></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="pstrut" style="height:2.7em;"></span>∥x</span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="mord mathnormal"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mclose delimcenter" style="top:0em;">∥</span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist" style="height:0.85em;"><span style="top:-2.85em;"><span class="pstrut" style="height:3.2em;"></span><span style="width:0.556em;height:1.200em;"><svg translate="no" xmlns="http://www.w3.org/2000/svg" width="0.556em" height="1.200em" viewBox="0 0 556 1200"><path d="M145 15 v585 v0 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M188 15 H145 v585 v0 v585 h43z
M367 15 v585 v0 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M410 15 H367 v585 v0 v585 h43z"/></svg></span></span></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;"> </span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">∥</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="mord mathnormal">(x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">,</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">x</span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">~</span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">)</span></span></span></span></span></span></span></span></span><span class="vlist" style="height:0.85em;"><span style="top:-2.85em;"><span class="pstrut" style="height:3.2em;"></span><span style="width:0.556em;height:1.200em;"><svg translate="no" xmlns="http://www.w3.org/2000/svg" width="0.556em" height="1.200em" viewBox="0 0 556 1200"><path d="M145 15 v585 v0 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M188 15 H145 v585 v0 v585 h43z
M367 15 v585 v0 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M410 15 H367 v585 v0 v585 h43z"/></svg></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s"></span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span> </span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.054em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"> </span></span></span></span></span></span></span></span></span></span></span>2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">+</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">h</span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mopen delimcenter" style="top:0em;"> ⊥</span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mord mathnormal" style="margin-right:0.02691em;">(w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mord"><span class="mord mathnormal">∥x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">∥<span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="minner"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">∥r</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">⊥</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="mord mathnormal">(x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">,</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3em;"></span><span class="vlist-s"> </span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span><span class="vlist-r"><span class="vlist" style="height:0.607em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>下图显示了一个二维示例，说明平行分量造成的误差更大，可能导致不正确的近邻结果，因此需要更严重的惩罚。</p>
<p>
  
   <span class="img-wrapper"> <img translate="no" src="https://assets.zilliz.com/quantization_cp_81e23dd1df.png" alt="The left figure shows poor quantization because the parallel offset affects the final result, while the right figure shows better quantization." class="doc-image" id="the-left-figure-shows-poor-quantization-because-the-parallel-offset-affects-the-final-result,-while-the-right-figure-shows-better-quantization." />
   </span> <span class="img-wrapper"> <span>左图显示的量化效果较差，因为并行偏移会影响最终结果，而右图显示的量化效果较好。</span> </span></p>
<h3 id="4-bit-PQ-FastScan" class="common-anchor-header">4 位 PQ 快速扫描</h3><p>让我们先回顾一下 PQ 的计算过程：在查询过程中，查询和子扇区聚类中心之间的距离会被预先计算，以构建一个查找表。然后通过查找表进行距离计算，以获得分段距离并求和。</p>
<p>
  <span class="img-wrapper">
    <img translate="no" src="https://assets.zilliz.com/PQ_Fast_Scan1_248c53bc93.png" alt="" class="doc-image" id="" />
    <span></span>
  </span>
</p>
<p>然而，频繁读取内存仍会成为性能瓶颈。如果能将查找表做得足够小，以适合寄存器，那么内存读取操作就可以转化为高效的 CPU SIMD 指令。</p>
<p>首先，每个子扇区被聚类为 16 个类，因此一个 4 位值可以代表一个聚类中心--这就是 "4 位 PQ "名称的由来。然后，使用标量量化（SQ）技术将通常以浮点表示的距离进一步转换为 uint8。这样，一个子扇区的查找表就可以用 16 × 8 = 128 位存储在寄存器中。</p>
<p>
  <span class="img-wrapper">
    <img translate="no" src="https://assets.zilliz.com/PQ_Fast_Scan2_07b9589195.png" alt="" class="doc-image" id="" />
    <span></span>
  </span>
</p>
<p>最后，让我们来研究一下寄存器的存储布局（以 AVX2 指令集为例）：32 向量的子向量与查找表结合，被放置在一个 128 位的寄存器中。这样，"查找 "操作就可以通过一条 SIMD shuffle CPU 指令高效完成。</p>
<p>
  
   <span class="img-wrapper"> <img translate="no" src="https://assets.zilliz.com/register_layout_b2bf8c2b2b.png" alt="register layout" class="doc-image" id="register-layout" />
   </span> <span class="img-wrapper"> <span>寄存器布局</span> </span></p>
<p>
  
   <span class="img-wrapper"> <img translate="no" src="https://assets.zilliz.com/SIMD_Shuffle_for_Lookup_c86e6d9657.png" alt="SIMD Shuffle for Lookup" class="doc-image" id="simd-shuffle-for-lookup" />
   </span> <span class="img-wrapper"> <span>用于查找的 SIMD 洗牌</span> </span>指令</p>
<p>这里有一个有趣的现象：ScaNN 论文完全侧重于第一项优化，这是合理的，因为它可以被视为一篇强调数学推导的算法论文。然而，论文中展示的实验结果却令人印象深刻。</p>
<p>
  
   <span class="img-wrapper"> <img translate="no" src="https://assets.zilliz.com/experimental_results_a46ec830a7.png" alt="The experimental results presented in the ScaNN paper." class="doc-image" id="the-experimental-results-presented-in-the-scann-paper." />
   </span> <span class="img-wrapper"> <span>ScaNN 论文中的实验结果</span>。 </span></p>
<p>直观地说，单纯优化损耗不应该产生如此显著的效果。另一个<a href="https://medium.com/@kumon/similarity-search-scann-and-4-bit-pq-fastscan-ab98766b32bd">博客</a>也指出了这一点--真正产生差异的是 4 位 PQ FastScan 部分。</p>
<h2 id="Experimental-Results" class="common-anchor-header">实验结果<button data-href="#Experimental-Results" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>我们使用向量数据库基准工具<a href="https://github.com/zilliztech/VectorDBBench">VectorDBBench</a> 进行了一次简单的测试。与传统的 IVFFLAT 和 IVF_PQ 相比，ScaNN 的性能优势非常明显。集成到 Milvus 后，在相同召回率的 Cohere1M 数据集上，QPS 可以达到 IVFFLAT 的 5 倍，IVF_PQ 的 6 倍。</p>
<p>不过，QPS 略低于 HNSW 等基于图的索引，因此不是高 QPS 用例的首选。但对于召回率较低的应用场景（如某些推荐系统），使用 ScaNN 而不加载原始数据，可以以极低的内存占用（原始数据的 1/16）达到令人印象深刻的 QPS，使其成为一个极佳的索引选择。</p>
<table>
<thead>
<tr><th>索引类型</th><th>案例</th><th>QPS</th><th>延迟（p99）</th><th>调用</th><th>内存</th></tr>
</thead>
<tbody>
<tr><td>IVFFLAT</td><td>性能1M</td><td>266</td><td>0.0173s</td><td>0.9544</td><td>3G</td></tr>
<tr><td>HNSW</td><td>性能1M</td><td>1885</td><td>0.0054s</td><td>0.9438</td><td>3.24G</td></tr>
<tr><td>IVF_PQ</td><td>性能1M</td><td>208</td><td>0.0292s</td><td>0.928</td><td>0.375G</td></tr>
<tr><td>ScaNN（with_raw_data: true）</td><td>性能1M</td><td>1215</td><td>0.0069s</td><td>0.9389</td><td>3.186G</td></tr>
<tr><td>ScaNN（with_raw_data: false）</td><td>性能1M</td><td>1265</td><td>0.0071s</td><td>0.7066</td><td>0.186G</td></tr>
</tbody>
</table>
<h2 id="Conclusion" class="common-anchor-header">结论<button data-href="#Conclusion" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>ScaNN 建立在我们熟悉的 IVFPQ 框架基础上，但通过在量化和底层查找加速方面的深入工程工作，将其大大推进了一步。ScaNN 将量化目标与排名质量保持一致，并消除了内循环中的内存瓶颈，从而将分数感知量化与 4 位 PQ FastScan 路径相结合，将传统的内存受限流程转变为高效的 SIMD 友好计算。</p>
<p>在实践中，这为 ScaNN 提供了一个清晰明确的定位。在高召回设置中，ScaNN 并不打算取代 HNSW 等基于图的索引。相反，对于内存预算紧张、对召回不敏感的工作负载，ScaNN 以非常小的占用空间提供了高吞吐量。在我们的实验中，集成到 Milvus VectorDB 后，ScaNN 在 Cohere1M 数据集上的 QPS 大约是 IVFFLAT 的 5 倍，这使它成为高吞吐量、低延迟 ANN 检索的有力选择，在这种情况下，压缩和效率比完美召回更重要。</p>
<p>如果您有兴趣进一步了解 ScaNN 或讨论实际系统中的索引选择，请加入我们的<a href="https://milvusio.slack.com/join/shared_invite/zt-3nntzngkz-gYwhrdSE4~76k0VMyBfD1Q#/shared-invite/email">Slack 频道</a>，与我们的工程师和社区中的其他人工智能工程师聊天。您还可以通过<a href="https://milvus.io/blog/join-milvus-office-hours-to-get-support-from-vectordb-experts.md">Milvus Office Hours</a> 预订 20 分钟的一对一课程，以获得见解、指导和问题解答。</p>
