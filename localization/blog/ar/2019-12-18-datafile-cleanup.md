---
id: 2019-12-18-datafile-cleanup.md
title: استراتيجية الحذف السابقة والمشاكل ذات الصلة
author: Yihua Mo
date: 2019-12-18T00:00:00.000Z
desc: قمنا بتحسين استراتيجية حذف الملفات لإصلاح المشكلات المتعلقة بعملية الاستعلام.
cover: null
tag: Engineering
---
<custom-h1>تحسينات على آلية تنظيف ملفات البيانات</custom-h1><blockquote>
<p>المؤلف ييهوا مو</p>
<p>التاريخ: 2019-12-18</p>
</blockquote>
<h2 id="Previous-delete-strategy-and-related-problems" class="common-anchor-header">استراتيجية الحذف السابقة والمشاكل ذات الصلة<button data-href="#Previous-delete-strategy-and-related-problems" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>في <a href="/blog/ar/2019-11-08-data-management.md">إدارة البيانات في محرك البحث المتجه واسع النطاق،</a> ذكرنا آلية حذف ملفات البيانات. يتضمن الحذف الحذف الناعم والحذف الصلب. بعد إجراء عملية حذف على جدول، يتم تمييز الجدول بالحذف الناعم. لا يُسمح بعمليات البحث أو التحديث بعد ذلك. ومع ذلك، لا يزال من الممكن تشغيل عملية الاستعلام التي تبدأ قبل الحذف. يتم حذف الجدول بالفعل مع البيانات الوصفية والملفات الأخرى فقط عند اكتمال عملية الاستعلام.</p>
<p>إذن، متى يتم حذف الملفات التي تم وضع علامة الحذف الناعم عليها بالفعل؟ قبل الإصدار 0.6.0، كانت الاستراتيجية هي أن الملف يتم حذفه بالفعل بعد الحذف الناعم لمدة 5 دقائق. يعرض الشكل التالي الاستراتيجية:</p>
<p>
  
   <span class="img-wrapper"> <img translate="no" src="https://raw.githubusercontent.com/milvus-io/community/master/blog/assets/datafile_clean/5mins.png" alt="5mins" class="doc-image" id="5mins" />
   </span> <span class="img-wrapper"> <span>5 دقائق</span> </span></p>
<p>تعتمد هذه الاستراتيجية على فرضية أن الاستعلامات لا تدوم عادةً أكثر من 5 دقائق ولا يمكن الاعتماد عليها. إذا استمر الاستعلام لأكثر من 5 دقائق، سيفشل الاستعلام. والسبب في ذلك هو أنه عند بدء الاستعلام، يجمع Milvus معلومات حول الملفات التي يمكن البحث فيها وينشئ مهام الاستعلام. بعد ذلك، يقوم برنامج جدولة الاستعلام بتحميل الملفات إلى الذاكرة واحداً تلو الآخر ويبحث عن الملفات واحداً تلو الآخر. إذا لم يعد أحد الملفات موجوداً عند تحميل ملف ما، سيفشل الاستعلام.</p>
<p>قد يساعد تمديد الوقت في تقليل مخاطر فشل الاستعلام، ولكنه يسبب أيضاً مشكلة أخرى: استخدام القرص بشكل كبير جداً. والسبب هو أنه عندما يتم إدراج كميات كبيرة من المتجهات، يقوم ميلفوس باستمرار بدمج ملفات البيانات ولا تتم إزالة الملفات المدمجة من القرص على الفور، على الرغم من عدم حدوث أي استعلام. إذا كان إدراج البيانات سريعًا جدًا و/أو كانت كمية البيانات المدرجة كبيرة جدًا، يمكن أن يصل استخدام القرص الإضافي إلى عشرات الجيجابايت. ارجع إلى الشكل التالي كمثال:</p>
<p>
  
   <span class="img-wrapper"> <img translate="no" src="https://raw.githubusercontent.com/milvus-io/community/master/blog/assets/datafile_clean/5min_result.png" alt="result" class="doc-image" id="result" />
   </span> <span class="img-wrapper"> <span>النتيجة</span> </span></p>
<p>كما هو مبين في الشكل السابق، يتم مسح الدفعة الأولى من البيانات المدرجة (إدراج_1) إلى القرص وتصبح الملف_1، ثم إدراج_2 تصبح الملف_2. يقوم الخيط المسؤول عن دمج الملفات بدمج الملفات في الملف_3. بعد ذلك، يتم وضع علامة على الملف_1 والملف_2 كحذف ناعم. الدفعة الثالثة من بيانات الإدراج تصبح الملف_4. يدمج مؤشر الترابط الملف_3 والملف_4 في الملف_5 ويضع علامة على الملف_3 والملف_4 كحذف ناعم.</p>
<p>وبالمثل، يتم دمج الإدراج_6 والإدراج_5. في t3، يتم وضع علامة على الملف_5 والملف_6 كحذف ناعم. بين t3 و t4، على الرغم من أن العديد من الملفات تم وضع علامة الحذف الناعم عليها، إلا أنها لا تزال في القرص. يتم حذف الملفات بالفعل بعد t4. وبالتالي، بين t3 و t4، يكون استخدام القرص 64 + 64 + 64 + 128 + 64 + 64 + 196 + 64 + 64 + 256 = 836 ميغابايت. البيانات المدرجة هي 64 + 64 + 64 + 64 + 64 + 64 + 64 = 256 ميجابايت. استخدام القرص هو 3 أضعاف حجم البيانات المدرجة. كلما زادت سرعة الكتابة على القرص، زاد استخدام القرص خلال فترة زمنية محددة.</p>
<h2 id="Improvements-of-the-delete-strategy-in-060" class="common-anchor-header">تحسينات استراتيجية الحذف في 0.6.0<button data-href="#Improvements-of-the-delete-strategy-in-060" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>وبالتالي، قمنا بتغيير استراتيجية حذف الملفات في الإصدار 0.6.0. لم يعد الحذف الصلب يستخدم الوقت كمشغّل. بدلاً من ذلك، يكون المشغل عندما لا يكون الملف قيد الاستخدام من قبل أي مهمة.</p>
<p>
  
   <span class="img-wrapper"> <img translate="no" src="https://raw.githubusercontent.com/milvus-io/community/master/blog/assets/datafile_clean/new_strategy.png" alt="newstrategy" class="doc-image" id="newstrategy" />
   </span> <span class="img-wrapper"> <span>استراتيجية جديدة</span> </span></p>
<p>افترض أنه تم إدراج دفعتين من المتجهات. في t1 يتم إعطاء طلب استعلام، يحصل Milvus على ملفين ليتم الاستعلام عنهما (الملف_1 والملف_2، لأن الملف_3 لا يزال غير موجود.) ثم يبدأ مؤشر ترابط الواجهة الخلفية في دمج الملفين مع الاستعلام الذي يعمل في نفس الوقت. عندما يتم إنشاء الملف_3، يتم وضع علامة على الملف_1 والملف_2 كحذف ناعم. بعد الاستعلام، لن تستخدم أي مهام أخرى الملف_1 والملف_2 لذا سيتم حذفهما بشكل نهائي في t4. الفاصل الزمني بين t2 و t4 صغير جدًا ويعتمد على الفاصل الزمني للاستعلام. بهذه الطريقة، ستتم إزالة الملفات غير المستخدمة في الوقت المناسب.</p>
<p>أما بالنسبة للتنفيذ الداخلي، فيتم استخدام العدّ المرجعي، وهو أمر مألوف لمهندسي البرمجيات، لتحديد ما إذا كان يمكن حذف ملف ما بشكل صعب. وللتوضيح باستخدام المقارنة، عندما يكون لدى اللاعب أرواح في اللعبة، لا يزال بإمكانه اللعب. عندما يصبح عدد الأرواح 0، تنتهي اللعبة. يراقب ميلفوس حالة كل ملف. عندما يتم استخدام ملف من قبل مهمة، ستتم إضافة حياة إلى الملف. عندما لا يتم استخدام الملف، ستتم إزالة حياة من الملف. عندما يتم تمييز الملف بالحذف الناعم ويكون عدد الأرواح 0، يكون الملف جاهزًا للحذف الصلب.</p>
<h2 id="Related-blogs" class="common-anchor-header">المدونات ذات الصلة<button data-href="#Related-blogs" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><ul>
<li><a href="/blog/ar/2019-11-08-data-management.md">إدارة البيانات في محرك البحث المتجه الضخم على نطاق واسع</a></li>
<li><a href="https://milvus.io/blog/managing-metadata-in-milvus-1.md">إدارة البيانات الوصفية لميلفوس (1): كيفية عرض البيانات الوصفية</a></li>
<li><a href="/blog/ar/2019-12-27-meta-table.md">إدارة البيانات الوصفية في ميلفوس لإدارة البيانات الوصفية (2): الحقول في جدول البيانات الوصفية</a></li>
</ul>
