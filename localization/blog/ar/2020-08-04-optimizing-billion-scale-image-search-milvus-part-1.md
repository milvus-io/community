---
id: optimizing-billion-scale-image-search-milvus-part-1.md
title: نظرة عامة
author: Rife Wang
date: 2020-08-04T20:39:09.882Z
desc: >-
  دراسة حالة مع UPYUN. تعرف على كيفية تميز Milvus عن حلول قواعد البيانات
  التقليدية ومساعدته في بناء نظام بحث عن تشابه الصور.
cover: assets.zilliz.com/header_23bbd76c8b.jpg
tag: Scenarios
canonicalUrl: 'https://zilliz.com/blog/optimizing-billion-scale-image-search-milvus-part-1'
---
<custom-h1>رحلة تحسين البحث عن الصور على نطاق المليار صورة (1/2)</custom-h1><p>يخدم Yupoo Picture Manager عشرات الملايين من المستخدمين ويدير عشرات المليارات من الصور. ومع ازدياد حجم معرض الصور الخاص بمستخدميه، أصبح لدى Yupoo حاجة ماسة إلى حل يمكنه تحديد موقع الصورة بسرعة. بمعنى آخر، عندما يقوم المستخدم بإدخال صورة ما، يجب أن يعثر النظام على صورته الأصلية والصور المماثلة في المعرض. يوفر تطوير خدمة البحث حسب الصورة نهجاً فعالاً لهذه المشكلة.</p>
<p>خضعت خدمة البحث عن طريق الصورة لتطورين:</p>
<ol>
<li>بدء التحقيق التقني الأول في أوائل عام 2019 وإطلاق الجيل الأول من النظام في مارس وأبريل 2019;</li>
<li>بدأ التحقيق في خطة الترقية في أوائل عام 2020 وبدأت الترقية الشاملة لنظام الجيل الثاني في أبريل 2020.</li>
</ol>
<p>تصف هذه المقالة اختيار التكنولوجيا والمبادئ الأساسية وراء الجيلين من نظام البحث بالصور بناءً على تجربتي الخاصة في هذا المشروع.</p>
<h2 id="Overview" class="common-anchor-header">نظرة عامة<button data-href="#Overview" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><h3 id="What-is-an-image" class="common-anchor-header">ما هي الصورة؟</h3><p>يجب أن نعرف ما هي الصورة قبل التعامل مع الصور.</p>
<p>الإجابة هي أن الصورة هي مجموعة من وحدات البكسل.</p>
<p>على سبيل المثال، الجزء الموجود في المربع الأحمر في هذه الصورة هو فعليًا سلسلة من البكسلات.</p>
<p>
  
   <span class="img-wrapper"> <img translate="no" src="https://assets.zilliz.com/1_what_is_an_image_021e0280cc.png" alt="1-what-is-an-image.png" class="doc-image" id="1-what-is-an-image.png" />
   </span> <span class="img-wrapper"> <span>1-ما هو-ما هو-صورة.png</span> </span></p>
<p>لنفترض أن الجزء الموجود في المربع الأحمر عبارة عن صورة، فإن كل مربع صغير مستقل في الصورة هو بكسل، وهو وحدة المعلومات الأساسية. بعد ذلك، يكون حجم الصورة 11 × 11 بكسل.</p>
<p>
  
   <span class="img-wrapper"> <img translate="no" src="https://assets.zilliz.com/2_what_is_an_image_602a91b4a0.png" alt="2-what-is-an-image.png" class="doc-image" id="2-what-is-an-image.png" />
   </span> <span class="img-wrapper"> <span>2-ما-ما-هو-صورة.png</span> </span></p>
<h3 id="Mathematical-representation-of-images" class="common-anchor-header">التمثيل الرياضي للصور</h3><p>يمكن تمثيل كل صورة بمصفوفة. يتوافق كل بكسل في الصورة مع عنصر في المصفوفة.</p>
<h3 id="Binary-images" class="common-anchor-header">الصور الثنائية</h3><p>تكون وحدات البكسل في صورة ثنائية إما سوداء أو بيضاء، لذا يمكن تمثيل كل بكسل بـ 0 أو 1. على سبيل المثال، تمثيل المصفوفة لصورة ثنائية 4*4 هو</p>
<pre><code translate="no">0 1 0 1
1 0 0 0
1 1 1 0
0 0 1 0
</code></pre>
<h3 id="RGB-images" class="common-anchor-header">صور RGB</h3><p>يمكن مزج الألوان الأساسية الثلاثة (الأحمر والأخضر والأزرق) لإنتاج أي لون. بالنسبة لصور RGB، يحتوي كل بكسل على المعلومات الأساسية لثلاث قنوات RGB. وبالمثل، إذا كانت كل قناة تستخدم رقم 8 بت (في 256 مستوى) لتمثيل مقياسها الرمادي، فإن التمثيل الرياضي للبكسل هو</p>
<pre><code translate="no">([0 .. 255], [0 .. 255], [0 .. 255])
</code></pre>
<p>إذا أخذنا صورة 4*4 RGB كمثال:</p>
<p>
  
   <span class="img-wrapper"> <img translate="no" src="https://assets.zilliz.com/3_4_x_4_rgb_image_136cec77ce.png" alt="3-4-x-4-rgb-image.png" class="doc-image" id="3-4-x-4-rgb-image.png" />
   </span> <span class="img-wrapper"> <span>3-4-x-4-rgb-image.png</span> </span></p>
<p>يتمثل جوهر معالجة الصور في معالجة مصفوفات البكسل هذه.</p>
<h2 id="The-technical-problem-of-search-by-image" class="common-anchor-header">المشكلة التقنية للبحث بالصورة<button data-href="#The-technical-problem-of-search-by-image" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>إذا كنت تبحث عن الصورة الأصلية، أي صورة بنفس وحدات البكسل بالضبط، فيمكنك مقارنة قيم MD5 الخاصة بها مباشرةً. ومع ذلك، فإن الصور التي يتم تحميلها على الإنترنت غالبًا ما تكون مضغوطة أو تحمل علامة مائية. حتى التغيير البسيط في الصورة يمكن أن يؤدي إلى نتيجة MD5 مختلفة. طالما أن هناك عدم اتساق في وحدات البكسل، فمن المستحيل العثور على الصورة الأصلية.</p>
<p>بالنسبة لنظام البحث حسب الصورة، نريد البحث عن الصور ذات المحتوى المتشابه. إذن، نحتاج إلى حل مشكلتين أساسيتين:</p>
<ul>
<li>تمثيل أو تجريد الصورة كصيغة بيانات يمكن معالجتها بواسطة الكمبيوتر.</li>
<li>يجب أن تكون البيانات قابلة للمقارنة لحسابها.</li>
</ul>
<p>وبشكل أكثر تحديدًا، نحتاج إلى الميزات التالية:</p>
<ul>
<li>استخراج سمات الصورة.</li>
<li>حساب الميزات (حساب التشابه).</li>
</ul>
<h2 id="The-first-generation-search-by-image-system" class="common-anchor-header">الجيل الأول من نظام البحث حسب الصورة<button data-href="#The-first-generation-search-by-image-system" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><h3 id="Feature-extraction--image-abstraction" class="common-anchor-header">استخراج الميزات - تجريد الصورة</h3><p>يستخدم الجيل الأول من نظام البحث عن طريق الصورة من الجيل الأول خوارزمية التجزئة الإدراكية أو خوارزمية pHash لاستخراج الميزة. ما هي أساسيات هذه الخوارزمية؟</p>
<p>
  
   <span class="img-wrapper"> <img translate="no" src="https://assets.zilliz.com/4_first_generation_image_search_ffd7088158.png" alt="4-first-generation-image-search.png" class="doc-image" id="4-first-generation-image-search.png" />
   </span> <span class="img-wrapper"> <span>4-الجيل الأول-الجيل الأول-البحث عن الصور. png</span> </span></p>
<p>كما هو موضح في الشكل أعلاه، تقوم خوارزمية pHash بإجراء سلسلة من التحويلات على الصورة للحصول على قيمة التجزئة. أثناء عملية التحويل، تقوم الخوارزمية بتجريد الصور باستمرار، وبالتالي تدفع نتائج الصور المتشابهة إلى التقارب بين الصور المتشابهة.</p>
<h3 id="Feature-calculation--similarity-calculation" class="common-anchor-header">حساب الميزات - حساب التشابه</h3><p>كيف يمكن حساب التشابه بين قيم التجزئة لصورتين؟ الإجابة هي استخدام مسافة هامينج. كلما كانت مسافة هامينج أصغر، كلما كان محتوى الصور أكثر تشابهًا.</p>
<p>ما هي مسافة هامينج؟ هي عدد البتات المختلفة.</p>
<p>على سبيل المثال,</p>
<pre><code translate="no">Value 1： 0 1 0 1 0
Value 2： 0 0 0 1 1
</code></pre>
<p>هناك بتتان مختلفتان في القيمتين السابقتين، لذا فإن مسافة هامينج بينهما هي 2.</p>
<p>الآن نحن نعرف مبدأ حساب التشابه. والسؤال التالي هو، كيف نحسب مسافات هامينج لبيانات بمقياس 100 مليون من 100 مليون صورة؟ باختصار، كيف نبحث عن الصور المتشابهة؟</p>
<p>في المرحلة المبكرة من المشروع، لم أجد أداة مرضية (أو محرك حوسبة) يمكنه حساب مسافة هامينج بسرعة. لذلك غيرت خطتي.</p>
<p>فكرتي هي أنه إذا كانت مسافة هامينج بين قيمتي pHash صغيرة، فيمكنني قطع قيم pHash ومن المحتمل أن تكون الأجزاء الصغيرة المقابلة متساوية.</p>
<p>على سبيل المثال</p>
<pre><code translate="no">Value 1： 8 a 0 3 0 3 f 6
Value 2： 8 a 0 3 0 3 d 8
</code></pre>
<p>نقسم القيمتين أعلاه إلى ثمانية أجزاء، وتكون قيم ستة أجزاء متماثلة تماماً. يمكن الاستدلال على أن المسافة بينهما متقاربة وبالتالي هاتان الصورتان متشابهتان.</p>
<p>بعد عملية التحويل، يمكنك أن تجد أن مشكلة حساب مسافة هامينج أصبحت مشكلة تكافؤ مطابقة. إذا قسمت كل قيمة pHash إلى ثمانية أجزاء، طالما أن هناك أكثر من خمسة أجزاء لها نفس القيم بالضبط، فإن قيمتي pHash متشابهتان.</p>
<p>وبالتالي من السهل جدًا حل مطابقة التكافؤ. يمكننا استخدام التصفية الكلاسيكية لنظام قاعدة البيانات التقليدية.</p>
<p>وبالطبع، أستخدم المطابقة متعددة الفصول وأحدد درجة المطابقة باستخدام الحد الأدنى_should_match في ElasticSearch (لا تقدم هذه المقالة مبدأ ES، يمكنك تعلمه بنفسك).</p>
<p>لماذا نختار ElasticSearch؟ أولاً، لأنه يوفر وظيفة البحث المذكورة أعلاه. ثانيًا، يستخدم مشروع مدير الصور في حد ذاته ES لتوفير وظيفة البحث عن النص الكامل وهو اقتصادي للغاية لاستخدام الموارد الموجودة.</p>
<h2 id="Summary-of-the-first-generation-system" class="common-anchor-header">ملخص نظام الجيل الأول<button data-href="#Summary-of-the-first-generation-system" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>يختار الجيل الأول من نظام البحث بالصور من الجيل الأول حل pHash + ElasticSearch، والذي يتميز بالميزات التالية:</p>
<ul>
<li>خوارزمية pHash سهلة الاستخدام ويمكنها مقاومة درجة معينة من الضغط والعلامة المائية والضوضاء.</li>
<li>يستخدم ElasticSearch الموارد الحالية للمشروع دون إضافة تكاليف إضافية للبحث.</li>
<li>لكن محدودية هذا النظام واضحة: خوارزمية pHash هي تمثيل مجرد للصورة بأكملها. وبمجرد تدمير تكامل الصورة، مثل إضافة حد أسود للصورة الأصلية، يصبح من المستحيل تقريبًا الحكم على التشابه بين الصورة الأصلية والصور الأخرى.</li>
</ul>
<p>لاختراق هذه القيود، ظهر نظام البحث عن الصور من الجيل الثاني بتقنية أساسية مختلفة تمامًا.</p>
<p>هذا المقال بقلم rifewang، مستخدم Milvus ومهندس برمجيات في UPYUN. إذا أعجبك هذا المقال، فمرحبًا بك لتلقي التحية! https://github.com/rifewang</p>
