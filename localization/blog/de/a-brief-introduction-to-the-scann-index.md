---
id: a-brief-introduction-to-the-scann-index.md
title: Eine kurze Einführung in den ScaNN-Index
author: Jack Li
date: 2026-01-21T00:00:00.000Z
cover: assets.zilliz.com/scann_cover_9a9787ee8a.png
tag: Engineering
recommend: false
publishToMedium: true
tags: 'Milvus, vector database'
meta_keywords: 'ScaNN index, IVFPQ, vector similarity search, ANN, Milvus'
meta_title: |
  A Brief Introduction to the ScaNN Index and How It Improves IVFPQ
desc: >-
  Ein tiefer Einblick in den ScaNN-Index: wie er IVFPQ mit score-aware
  Quantisierung und 4-bit FastScan verbessert, plus Benchmark-Ergebnisse von
  Milvus auf dem Cohere1M-Datensatz.
origin: 'https://milvus.io/blog/a-brief-introduction-to-the-scann-index.md'
---
<p><a href="https://github.com/google-research/google-research/tree/master/scann">ScaNN</a> ist Googles Antwort auf eine bekannte Herausforderung bei der groß angelegten Vektorsuche: <strong>Wie lässt sich der Abfragedurchsatz erhöhen und die Speichernutzung reduzieren, ohne dass die Ergebnisqualität inakzeptabel leidet?</strong> Das Konzept von ScaNN basiert auf dem klassischen IVF+PQ-Rezept - grobes Clustering plus aggressive Produktquantisierung - aber es werden zwei wichtige Innovationen hinzugefügt, die die Leistungsgrenze deutlich verschieben:</p>
<ul>
<li><p><strong>Ein Quantisierungsziel, das</strong> die relative Reihenfolge echter Nachbarn besser beibehält und so die Qualität des Rankings selbst bei starker Kompression verbessert.</p></li>
<li><p><strong>FastScan</strong> ist ein SIMD-optimierter 4-Bit-PQ-Lookup-Pfad, der den traditionellen Engpass bei der Speicherbelastung reduziert, indem mehr Arbeit in den CPU-Registern verbleibt.</p></li>
</ul>
<p>In der Praxis ist dies eine gute Wahl, wenn Sie damit einverstanden sind, einen gewissen Rückruf gegen eine hohe QPS und einen viel kleineren Speicherbedarf einzutauschen (oft werden Vektoren auf ~1/16 der ursprünglichen Größe komprimiert), wie z. B. bei rückrufunempfindlichen Empfehlungsarbeiten.</p>
<p>In diesem Beitrag werden wir IVFPQ als Grundlage erneut betrachten, die wichtigsten Optimierungen, die ScaNN darauf aufbaut, untersuchen und mit experimentellen Ergebnissen abschließen, die die Diskussion auf die gemessene Leistung stützen.</p>
<h2 id="IVFPQ-Recap" class="common-anchor-header">IVFPQ-Rekapitulation<button data-href="#IVFPQ-Recap" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>ScaNN wurde von Google im Jahr 2020 vorgeschlagen, und das Papier berichtet eine 3× Leistungsverbesserung über HNSW auf dem GloVe-Datensatz. Einzelheiten finden Sie in der <a href="https://arxiv.org/pdf/1908.10396.pdf">Originalarbeit</a> und der <a href="https://github.com/google-research/google-research/tree/master/scann">Open-Source-Implementierung</a>.</p>
<p>Bevor wir ScaNN vorstellen, werden wir kurz IVFPQ rekapitulieren, da ScaNN auf demselben Gesamtrahmen aufbaut.</p>
<p><strong>IVFPQ steht für Inverted File with Product Quantization</strong>, ein Algorithmus, der für die effiziente und groß angelegte Approximate Nearest Neighbor (ANN) Suche in hochdimensionalen Vektordatenbanken verwendet wird. Es handelt sich um einen hybriden Ansatz, der zwei Techniken, den <strong>invertierten Dateiindex (IVF)</strong> und die <strong>Produktquantisierung (PQ)</strong>, kombiniert, um ein Gleichgewicht zwischen Suchgeschwindigkeit, Speicherverbrauch und Genauigkeit herzustellen.</p>
<h3 id="How-IVFPQ-Works" class="common-anchor-header">Wie funktioniert IVFPQ?</h3><p>Der Prozess umfasst zwei Hauptschritte bei der Indizierung und Suche:</p>
<ul>
<li>IVF-Schicht: Vektoren werden in <code translate="no">nlist</code> invertierten Listen (Clustern) geclustert. Bei der Abfrage wird nur eine Teilmenge von Clustern besucht (<code translate="no">nprobe</code>), um einen Kompromiss zwischen Abruf und Latenz/Durchsatz zu finden.</li>
</ul>
<p>
  <span class="img-wrapper">
    <img translate="no" src="https://assets.zilliz.com/ivf1_5e3d29c392.png" alt="" class="doc-image" id="" />
    <span></span>
  </span>
</p>
<ul>
<li>PQ-Schicht: Innerhalb jedes besuchten Clusters wird jeder D-dimensionale Vektor in m Untervektoren mit der Dimension (D/m) aufgeteilt. Jeder Untervektor wird quantisiert, indem er dem nächstgelegenen Schwerpunkt in seinem Unterkodebuch zugewiesen wird. Wenn ein Unterkodebuch 256 Schwerpunkte hat, kann jeder Untervektor durch einen <code translate="no">uint8</code> Code (eine ID in [0, 255]) dargestellt werden.</li>
</ul>
<p>
  <span class="img-wrapper">
    <img translate="no" src="https://assets.zilliz.com/pq2_6695c9cc6f.png" alt="" class="doc-image" id="" />
    <span></span>
  </span>
</p>
<p>Die Abstandsberechnung kann dann als Summe über die Untervektoren umgeschrieben werden:</p>
<p><strong>D(q, X) = D(q, u0) + D(q, u1) + D(q, u2) + ... + D(q, un)</strong></p>
<p><strong>= L(q, id1) + L(q, id2) + L(q, id3) + ... + L(q, idn)</strong></p>
<p>Hier steht L für eine Nachschlagetabelle. Zum Zeitpunkt der Abfrage wird die Nachschlagetabelle erstellt, die den Abstand zwischen der Abfrage und jedem quantisierten Untervektor aufzeichnet. Alle nachfolgenden Abstandsberechnungen werden in Tabellennachschlageoperationen mit anschließender Summierung umgewandelt.</p>
<p>
  <span class="img-wrapper">
    <img translate="no" src="https://assets.zilliz.com/query_vector3_75d47bdd53.png" alt="" class="doc-image" id="" />
    <span></span>
  </span>
</p>
<p>Wenn zum Beispiel bei 128-dimensionalen Vektoren, die in 32 Untervektoren von je 4 Dimensionen aufgeteilt sind, jeder Untervektor durch eine <code translate="no">uint8</code> ID kodiert wird, sinken die Speicherkosten pro Vektor von (128 x 4) Byte auf (32 x 1) Byte - eine Reduzierung um 1/16.</p>
<h2 id="ScaNN-Optimizations-Based-on-IVFPQ" class="common-anchor-header">ScaNN-Optimierungen auf der Grundlage von IVFPQ<button data-href="#ScaNN-Optimizations-Based-on-IVFPQ" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>Zusammenfassend lässt sich sagen, dass ScaNN IVFPQ in zweierlei Hinsicht verbessert:</p>
<ol>
<li><p>Quantisierung: ScaNN schlägt ein Ziel vor, das über das einfache Ersetzen jedes Untervektors durch den nächstgelegenen k-means-Schwerpunkt hinausgeht (d. h. Minimierung des Rekonstruktionsfehlers).</p></li>
<li><p>Effizienz des Nachschlagens: ScaNN beschleunigt die LUT-basierte Suche, die oft speicherabhängig ist, über einen SIMD-freundlichen FastScan-Pfad.</p></li>
</ol>
<h3 id="Score-aware-Quantization-Loss" class="common-anchor-header">Quantisierungsverlust unter Berücksichtigung des Ergebnisses</h3><p>
  <span class="img-wrapper">
    <img translate="no" src="https://assets.zilliz.com/text_765e538864.png" alt="" class="doc-image" id="" />
    <span></span>
  </span>
</p>
<p>
  <span class="img-wrapper">
    <img translate="no" src="https://assets.zilliz.com/score_aware_quantization_loss_d9d36223c2.png" alt="" class="doc-image" id="" />
    <span></span>
  </span>
</p>
<p>
  <span class="img-wrapper">
    <img translate="no" src="https://assets.zilliz.com/text2_dd95418ba9.png" alt="" class="doc-image" id="" />
    <span></span>
  </span>
</p>
<p>
  <span class="img-wrapper">
    <img translate="no" src="https://assets.zilliz.com/quantizer_f0e39762a4.png" alt="" class="doc-image" id="" />
    <span></span>
  </span>
</p>
<p>Da die Analyse auf der IP-Metrik basiert, wirkt sich nach der Zerlegung des Quantisierungsfehlers in parallele und senkrechte Komponenten durch ScaNN nur die parallele Komponente auf das Ergebnis aus, so dass ein größerer Strafterm angewendet werden sollte. Folglich kann die Verlustfunktion wie folgt umgeschrieben werden:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">ℓ(</mo><msub><mi>xi</mi></msub><mo separator="true">,</mo><msub><mi>x~i</mi></msub><mo separator="true">,</mo><mi>w</mi><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr></mtable></semantics></math></span></span></span><mrow></mrow><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>=h</mi></msub><mrow><mo fence="true">∥(</mo><mi>w</mi><mrow><mo fence="true">,</mo></mrow></mrow><msup><mrow><mo fence="true">∥xi∥)</mo><msub><mi>∥r</mi></msub><mrow><mo fence="true">∥(</mo><msub><mi>xi</mi></msub><mo separator="true">,</mo><msub><mi>x~i</mi></msub></mrow><mo fence="true">)</mo></mrow></msup><msub><mi>∥2+h</mi></msub><mrow><mo fence="true">⊥(</mo><mi>w</mi><mrow><mo fence="true">,</mo></mrow></mrow><msup><mrow><mo fence="true">∥xi∥)</mo><msub><mi>∥r</mi></msub><mrow><mo fence="true">⊥(</mo><msub><mi>xi</mi></msub><mo separator="true">,</mo><msub><mi>x~i</mi></msub></mrow><mo fence="true">)</mo></mrow></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">∥2\begin{aligned} \ell\left(x_i, \tilde{x}_i, w\right) &amp;=h_{\|}\left(w,\left\|x_i\right\|\right)\left\|r_{\|}\left(x_i, \tilde{x}_i\right)\right\|^2 +h_{\perp}\left(w,\left\|x_i\right\|\right)\left\|r_{\perp}\left(x_i,</annotation></semantics></math></span> \tilde{x}_i\right<span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><annotation encoding="application/x-tex">)\right\|^2 \end{aligned}</annotation></semantics></math></span></span></span><span class="strut" style="height:1.714em;vertical-align:-0.607em;"></span><span class="katex-display"><span class="katex"></span></span><span class="pstrut" style="height:3.054em;"></span> <span class="katex-display"><span class="katex">ℓ</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mord"><span class="mord mathnormal">(x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex">,</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex"></span></span><span class="pstrut" style="height:3em;"></span> <span class="katex-display"><span class="katex">x</span></span><span class="pstrut" style="height:3em;"></span><span class="katex-display"><span class="katex">~</span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex">,</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex">w<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">)</span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.607em;"><span></span></span></span><span class="katex-display"><span class="katex"></span></span><span class="pstrut" style="height:3.054em;"></span> <span class="katex-display"><span class="katex"></span></span><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span> <span class="katex-display"><span class="katex">=</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="katex-display"><span class="katex">h</span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">∥</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span><span class="katex-display"><span class="katex"></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mord mathnormal" style="margin-right:0.02691em;">(w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mord mathnormal"><span class="pstrut" style="height:3em;"></span><span class="pstrut" style="height:2.7em;"></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="pstrut" style="height:2.7em;"></span>∥x</span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="mord mathnormal"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mclose delimcenter" style="top:0em;"> ∥)</span></span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist" style="height:0.85em;"><span style="top:-2.85em;"><span class="pstrut" style="height:3.2em;"></span><span style="width:0.556em;height:1.200em;"><svg translate="no" xmlns="http://www.w3.org/2000/svg" width="0.556em" height="1.200em" viewBox="0 0 556 1200"><path d="M145 15 v585 v0 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M188 15 H145 v585 v0 v585 h43z
M367 15 v585 v0 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M410 15 H367 v585 v0 v585 h43z"/></svg></span></span></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;"> </span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">∥</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="mord mathnormal">(x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">,</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">x</span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">~</span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">)</span></span></span></span></span></span></span></span></span><span class="vlist" style="height:0.85em;"><span style="top:-2.85em;"><span class="pstrut" style="height:3.2em;"></span><span style="width:0.556em;height:1.200em;"><svg translate="no" xmlns="http://www.w3.org/2000/svg" width="0.556em" height="1.200em" viewBox="0 0 556 1200"><path d="M145 15 v585 v0 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M188 15 H145 v585 v0 v585 h43z
M367 15 v585 v0 v585 c2.667,10,9.667,15,21,15
c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15
c-10,0,-16.667,5,-20,15z M410 15 H367 v585 v0 v585 h43z"/></svg></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s"></span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span> </span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.054em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"> </span></span></span></span></span></span></span></span></span></span></span> 2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">+</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">h</span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">⊥</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mord mathnormal" style="margin-right:0.02691em;">(w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mord"><span class="mord mathnormal">∥x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="mclose delimcenter" style="top:0em;"> ∥)</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="minner"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">∥r</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">⊥</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="mord mathnormal">(x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.107em;"><span style="top:-3.107em;"><span class="mord"><span class="minner"><span class="minner"><span class="minner"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r">,</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span></span></span></span></span></span></span></span></span><span class="pstrut" style="height:3em;"></span><span class="vlist-s"> </span><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"></span><span class="vlist-r"><span class="vlist" style="height:0.607em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>Die folgende Abbildung zeigt ein zweidimensionales Beispiel, das veranschaulicht, dass der durch die parallele Komponente verursachte Fehler größer ist und zu falschen Ergebnissen bei der nächsten Nachbarschaft führen kann, so dass eine strengere Strafe gerechtfertigt ist.</p>
<p>
  
   <span class="img-wrapper"> <img translate="no" src="https://assets.zilliz.com/quantization_cp_81e23dd1df.png" alt="The left figure shows poor quantization because the parallel offset affects the final result, while the right figure shows better quantization." class="doc-image" id="the-left-figure-shows-poor-quantization-because-the-parallel-offset-affects-the-final-result,-while-the-right-figure-shows-better-quantization." />
   </span> <span class="img-wrapper"> <span>Die linke Abbildung zeigt eine schlechte Quantisierung, da der parallele Offset das Endergebnis beeinflusst, während die rechte Abbildung eine bessere Quantisierung zeigt.</span> </span></p>
<h3 id="4-bit-PQ-FastScan" class="common-anchor-header">4-Bit-PQ-FastScan</h3><p>Schauen wir uns zunächst den PQ-Berechnungsprozess an: Während der Abfrage werden die Abstände zwischen den Zentren der Abfrage und der Untervektoren vorberechnet, um eine Nachschlagetabelle zu erstellen. Die Abstandsberechnung erfolgt dann durch Tabellenabfragen, um Segmentabstände zu erhalten und diese zu summieren.</p>
<p>
  <span class="img-wrapper">
    <img translate="no" src="https://assets.zilliz.com/PQ_Fast_Scan1_248c53bc93.png" alt="" class="doc-image" id="" />
    <span></span>
  </span>
</p>
<p>Die häufigen Speicherzugriffe werden jedoch immer noch zu einem Leistungsengpass. Wenn die Nachschlagetabelle so klein gemacht werden kann, dass sie in Register passt, können Speicherleseoperationen in effiziente CPU-SIMD-Anweisungen umgewandelt werden.</p>
<p>Zunächst wird jeder Untervektor in 16 Klassen geclustert, so dass ein 4-Bit-Wert ein Clusterzentrum darstellen kann - daher auch der Name "4-Bit-PQ". Dann werden die Abstände, die normalerweise als Fließkommazahlen dargestellt werden, mithilfe der Skalarquantisierung (SQ) in uint8 umgewandelt. Auf diese Weise kann die Lookup-Tabelle für einen Untervektor in einem Register mit 16 × 8 = 128 Bits gespeichert werden.</p>
<p>
  <span class="img-wrapper">
    <img translate="no" src="https://assets.zilliz.com/PQ_Fast_Scan2_07b9589195.png" alt="" class="doc-image" id="" />
    <span></span>
  </span>
</p>
<p>Betrachten wir abschließend die Registerspeicheranordnung (am Beispiel des AVX2-Befehlssatzes): Die Untervektoren von 32 Vektoren werden zusammen mit der Lookup-Tabelle in einem 128-Bit-Register untergebracht. Die "Lookup"-Operation kann dann mit einem einzigen SIMD-Shuffle-CPU-Befehl effizient abgeschlossen werden.</p>
<p>
  
   <span class="img-wrapper"> <img translate="no" src="https://assets.zilliz.com/register_layout_b2bf8c2b2b.png" alt="register layout" class="doc-image" id="register-layout" />
   </span> <span class="img-wrapper"> <span>Register-Layout</span> </span></p>
<p>
  
   <span class="img-wrapper"> <img translate="no" src="https://assets.zilliz.com/SIMD_Shuffle_for_Lookup_c86e6d9657.png" alt="SIMD Shuffle for Lookup" class="doc-image" id="simd-shuffle-for-lookup" />
   </span> <span class="img-wrapper"> <span>SIMD-Shuffle für Lookup</span> </span></p>
<p>Hier eine interessante Beobachtung: Das ScaNN-Papier konzentriert sich ausschließlich auf die erste Optimierung, was vernünftig ist, da es als ein Algorithmus-Papier mit Schwerpunkt auf mathematischen Ableitungen betrachtet werden kann. Die experimentellen Ergebnisse, die in dem Papier vorgestellt werden, sind jedoch bemerkenswert beeindruckend.</p>
<p>
  
   <span class="img-wrapper"> <img translate="no" src="https://assets.zilliz.com/experimental_results_a46ec830a7.png" alt="The experimental results presented in the ScaNN paper." class="doc-image" id="the-experimental-results-presented-in-the-scann-paper." />
   </span> <span class="img-wrapper"> <span>Die experimentellen Ergebnisse, die in der ScaNN-Studie vorgestellt werden</span>. </span></p>
<p>Intuitiv sollte die Optimierung des Verlusts allein keine so dramatischen Auswirkungen haben. In einem anderen <a href="https://medium.com/@kumon/similarity-search-scann-and-4-bit-pq-fastscan-ab98766b32bd">Blog</a> wurde ebenfalls darauf hingewiesen, dass der 4-Bit-PQ-FastScan-Anteil den Unterschied ausmacht.</p>
<h2 id="Experimental-Results" class="common-anchor-header">Experimentelle Ergebnisse<button data-href="#Experimental-Results" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>Mit dem Vektordatenbank-Benchmark-Tool <a href="https://github.com/zilliztech/VectorDBBench">VectorDBBench</a> haben wir einen einfachen Test durchgeführt. Der Leistungsvorteil von ScaNN gegenüber den traditionellen IVFFLAT und IVF_PQ ist ganz offensichtlich. Nach der Integration in Milvus kann QPS auf dem Cohere1M-Datensatz bei gleicher Recall-Rate das Fünffache von IVFFLAT und das Sechsfache von IVF_PQ erreichen.</p>
<p>Der QPS ist jedoch etwas niedriger als der von graphenbasierten Indizes wie HNSW, so dass er nicht die erste Wahl für Anwendungsfälle mit hohem QPS ist. Für Szenarien mit geringerem Recall ist er jedoch akzeptabel (z. B. in einigen Empfehlungssystemen). Die Verwendung von ScaNN ohne das Laden von Rohdaten kann beeindruckende QPS mit einem extrem geringen Speicherbedarf (1/16 der Originaldaten) erreichen, was ihn zu einer ausgezeichneten Indexwahl macht.</p>
<table>
<thead>
<tr><th>Index_Typ</th><th>Fall</th><th>QPS</th><th>Latenz(p99)</th><th>Abruf</th><th>Speicher</th></tr>
</thead>
<tbody>
<tr><td>IVFFLAT</td><td>Leistung1M</td><td>266</td><td>0.0173s</td><td>0.9544</td><td>3G</td></tr>
<tr><td>HNSW</td><td>Leistung1M</td><td>1885</td><td>0.0054s</td><td>0.9438</td><td>3.24G</td></tr>
<tr><td>IVF_PQ</td><td>Leistung1M</td><td>208</td><td>0.0292s</td><td>0.928</td><td>0.375G</td></tr>
<tr><td>ScaNN（mit_Rohdaten: true）</td><td>Leistung1M</td><td>1215</td><td>0.0069s</td><td>0.9389</td><td>3.186G</td></tr>
<tr><td>ScaNN（mit_Rohdaten: false）</td><td>Leistung1M</td><td>1265</td><td>0.0071s</td><td>0.7066</td><td>0.186G</td></tr>
</tbody>
</table>
<h2 id="Conclusion" class="common-anchor-header">Schlussfolgerung<button data-href="#Conclusion" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>ScaNN baut auf dem vertrauten IVFPQ-Framework auf, erweitert es aber durch tiefgreifende Entwicklungsarbeit sowohl bei der Quantisierung als auch bei der Beschleunigung von Low-Level-Lookups erheblich. Durch die Anpassung des Quantisierungsziels an die Qualität des Rankings und die Beseitigung von Speicherengpässen in der inneren Schleife kombiniert ScaNN eine Score-bewusste Quantisierung mit einem 4-Bit-PQ-FastScan-Pfad, der einen traditionell speichergebundenen Prozess in eine effiziente, SIMD-freundliche Berechnung verwandelt.</p>
<p>In der Praxis bedeutet dies, dass ScaNN eine klare und gut definierte Nische hat. Es ist nicht dazu gedacht, graphbasierte Indizes wie HNSW in Umgebungen mit hohem Abruf zu ersetzen. Stattdessen liefert ScaNN für abrufunempfindliche Arbeitslasten mit knappen Speicherbudgets einen hohen Durchsatz bei sehr geringem Platzbedarf. In unseren Experimenten erreichte ScaNN nach der Integration in Milvus VectorDB etwa das Fünffache der QPS von IVFFLAT auf dem Cohere1M-Datensatz, was es zu einer guten Wahl für ANN-Abrufe mit hohem Durchsatz und geringer Latenz macht, bei denen Komprimierung und Effizienz wichtiger sind als ein perfekter Abruf.</p>
<p>Wenn Sie daran interessiert sind, ScaNN weiter zu erforschen oder die Indexauswahl in realen Systemen zu diskutieren, treten Sie unserem <a href="https://milvusio.slack.com/join/shared_invite/zt-3nntzngkz-gYwhrdSE4~76k0VMyBfD1Q#/shared-invite/email">Slack Channel</a> bei, um mit unseren Ingenieuren und anderen KI-Ingenieuren in der Community zu chatten. Sie können auch eine 20-minütige Einzelsitzung buchen, um Einblicke, Anleitung und Antworten auf Ihre Fragen über die <a href="https://milvus.io/blog/join-milvus-office-hours-to-get-support-from-vectordb-experts.md">Milvus-Sprechstunde</a> zu erhalten.</p>
