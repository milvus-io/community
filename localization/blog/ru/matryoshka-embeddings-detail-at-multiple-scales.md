---
id: matryoshka-embeddings-detail-at-multiple-scales
title: 'Вкрапления "Матрешки": Детализация в нескольких масштабах'
author: 'Stefan Webb, David Wang'
date: 2024-10-30T00:00:00.000Z
desc: >-
  Вкрапления с сокращенными размерами без ущерба для семантической целостности,
  идеально подходящие для более эффективного поиска и хранения.
metaTitle: What are Matryoshka Embeddings?
cover: assets.zilliz.com/Introduction_to_Matryoshka_Embedding_e5a5bc2056.png
tag: Engineering
tags: Matryoshka Embeddings
recommend: true
canonicalUrl: 'https://milvus.io/blog/matryoshka-embeddings-detail-at-multiple-scales'
---
<h2 id="What-are-Matryoshka-Embeddings" class="common-anchor-header">Что такое вкрапления "Матрешки"?<button data-href="#What-are-Matryoshka-Embeddings" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>При создании эффективных систем <a href="https://zilliz.com/learn/vector-similarity-search">векторного поиска</a> одной из ключевых задач является управление затратами на хранение данных при сохранении приемлемой задержки и запоминания. Современные <a href="https://zilliz.com/blog/choosing-the-right-embedding-model-for-your-data">модели встраивания</a> выдают векторы с сотнями или тысячами измерений, что создает значительные затраты на хранение и вычисления для исходного вектора и индекса.</p>
<p>Традиционно требования к хранению снижаются путем применения метода квантования или уменьшения размерности непосредственно перед построением индекса. Например, мы можем сэкономить место, снизив точность с помощью <a href="https://zilliz.com/learn/scalar-quantization-and-product-quantization">Product Quantization</a> (PQ) или количество измерений с помощью Principal Component Analysis (PCA). Эти методы анализируют весь набор векторов, чтобы найти более компактный, сохраняющий семантические связи между векторами.</p>
<p>Несмотря на свою эффективность, эти стандартные подходы снижают точность или размерность только один раз и в одном масштабе. Но что, если бы мы могли поддерживать несколько уровней детализации одновременно, как пирамиду все более точных представлений?</p>
<p>Появились <a href="https://arxiv.org/abs/2205.13147"><strong>вкрапления "Матрешки"</strong></a>. Названные в честь русской матрешки (см. иллюстрацию), эти умные конструкции встраивают несколько масштабов представления в один вектор. В отличие от традиционных методов постобработки, вкрапления "Матрешки" учатся этой многомасштабной структуре в процессе начального обучения. Результат поразителен: <strong>не только полное вложение отражает семантику входных данных, но и каждый вложенный префикс подмножества (первая половина, первая четверть и т. д.) обеспечивает целостное, хотя и менее детальное представление.</strong></p>
<p>
 <span class="img-wrapper">
   <img translate="no" src="https://assets.zilliz.com/Visualization_of_Matryoshka_embeddings_with_multiple_layers_of_detail_274f2c7aba.png" alt="Figure: Visualization of Matryoshka embeddings with multiple layers of detail" class="doc-image" id="figure:-visualization-of-matryoshka-embeddings-with-multiple-layers-of-detail" />
   <span>Рисунок: Визуализация вкраплений "Матрешки" с несколькими слоями детализации</span> </span></p>
<p><em>Рисунок: Визуализация вкраплений "Матрешки" с несколькими слоями детализации</em></p>
<p>Этот подход резко контрастирует с обычными <a href="https://zilliz.com/glossary/vector-embeddings">вкраплениями</a>, где использование произвольных подмножеств размерности вектора обычно разрушает семантический смысл. С вкраплениями Matryoshka вы можете выбрать ту степень детализации, которая наилучшим образом сбалансирует точность и вычислительные затраты в вашей конкретной задаче.</p>
<p>Нужен быстрый приблизительный поиск? Используйте самую маленькую "матрешку". Нужна максимальная точность? Используйте полное вложение. Такая гибкость делает их особенно ценными для систем, адаптирующихся к различным требованиям производительности или ограничениям ресурсов.</p>
<h2 id="Inference" class="common-anchor-header">Выводы<button data-href="#Inference" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>Ценным применением вкраплений "Матрешки" является ускорение поиска по сходству без ущерба для запоминания. Используя меньшие подмножества вкраплений запросов и баз данных - например, первые 1/32 их размерности - мы можем построить индекс по этому уменьшенному пространству, сохраняющий большую часть информации о сходстве. Исходные результаты из этого уменьшенного пространства вкраплений можно использовать напрямую. Тем не менее, существует техника, позволяющая увеличить запоминание и учесть любое незначительное уменьшение размерности, что делает этот подход эффективным и действенным для задач поиска по сходству.</p>
<p>
 <span class="img-wrapper">
   <img translate="no" src="https://assets.zilliz.com/How_the_funnel_search_works_with_Matryoshka_embeddings_8fa05a2fe7.png" alt="Figure: How the funnel search works with Matryoshka embeddings" class="doc-image" id="figure:-how-the-funnel-search-works-with-matryoshka-embeddings" />
   <span>Рисунок: Как работает воронкообразный поиск с вкраплениями "Матрешки</span> </span></p>
<p><em>Рисунок: Как работает воронкообразный поиск с вкраплениями Матрешки</em></p>
<p>Чтобы эффективно ускорить поиск сходства, сохранив при этом точность, мы можем использовать подход "воронкообразного поиска". Сначала мы выполняем первоначальный поиск сходства, используя только первые 1/32 измерения вкраплений, создавая широкий пул элементов-кандидатов. Затем мы ранжируем эти кандидаты на основе их сходства с запросом, используя первые 1/16 измерений, обрезая часть списка. Этот процесс продолжается итеративно, ранжируя и обрезая все более крупные подмножества размерностей встраивания - 1/8, 1/4 и так далее. Важно отметить, что мы выполняем только один первоначальный поиск сходства в этом более низкоразмерном пространстве, и за один проход модели встраивания вычисляется встраивание запроса. Этот процесс воронки сужает круг кандидатов на каждом шаге и является более быстрым и эффективным, чем прямой поиск в полноразмерном пространстве. Извлечение множества совпадений из 1/32-мерного пространства и их уточнение с помощью поиска в воронке позволяет значительно ускорить поиск по сходству, сохраняя при этом высокую запоминаемость.</p>
<h2 id="Training" class="common-anchor-header">Обучение<button data-href="#Training" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>Давайте рассмотрим некоторые технические детали. Метод очень прост в применении. Рассмотрим контекст тонкой настройки <a href="https://zilliz.com/learn/what-is-bert">BERT-модели</a> для встраивания предложений. Чтобы преобразовать BERT-модель, которая была предварительно обучена на потерях маскированных слов, в модель встраивания предложений, мы формируем встраивание предложений как среднее значение последнего слоя, то есть среднее значение контекстуализированных вкраплений для каждого слова.</p>
<p>Одним из вариантов цели обучения является <a href="https://sbert.net/docs/package_reference/sentence_transformer/losses.html#cosentloss">косинусная потеря предложения (CoSENT)</a>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>u</mi><mo separator="true">,</mo><mi>v</mi><mo separator="true">;</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L(u, v; s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span></span></span></span> L <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span> v <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span> s <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mclose">)</span></span></span></span>. На вход подается пара вкраплений предложений, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mo separator="true">,</mo><mi>vu</mi></mrow><annotation encoding="application/x-tex">,v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span></span></span></span> u <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span> v, и их желаемый балл сходства, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><annotation encoding="application/x-tex">ss</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span></span></span></span> s (формулу см. по ссылке выше). Теперь, чтобы выучить вкрапления "Матрешки", мы вносим небольшую модификацию в цель обучения:</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>LM</mi></msub><mo stretchy="false">(</mo><mi>u</mi><mo separator="true">,</mo><mi>v</mi><mo stretchy="false">)</mo><mi>=w0L</mi><mo stretchy="false">(</mo><msub><mrow><mn>u1</mn><mo>:</mo><mi>d</mi></mrow></msub><mo separator="true">,</mo><msub><mrow><mn>v1</mn><mo>:</mo><mi>d</mi></mrow></msub><mo stretchy="false">)</mo><mi>+w1L</mi><mo stretchy="false">(</mo><msub><mrow><mn>u1</mn><mo>:</mo><mn>d/2</mn></mrow></msub><mo separator="true">,</mo><msub><mrow><mn>v1</mn><mo>:</mo><mn>d/2</mn></mrow></msub><mo stretchy="false">)</mo><mi>+w2L</mi><mo stretchy="false">(</mo><msub><mrow><mn>u1</mn><mo>:</mo><mn>d/4</mn></mrow></msub><mo separator="true">,</mo><msub><mrow><mn>v1</mn><mo>:</mo><mn>d/4</mn></mrow></msub><mo stretchy="false">)</mo><mo>+⋯L_M</mo></mrow><annotation encoding="application/x-tex">(u, v) = w_0L(u_{1:d}, v_{1:d}) + w_1L(u_{1:d/2}, v_{1:</annotation></semantics></math></span></span><span class="pstrut" style="height:2.7em;"></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="strut" style="height:0.313em;"></span>d<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><annotation encoding="application/x-tex">/2}) + w_2L(u_{1:d/4}, v_{1:d/4}) + \cdots</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span></span></span> L<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span><span class="vlist-s">M</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">(u</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span></span></span> v<span class="katex-html" aria-hidden="true"><span class="base"><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span></span></span> =<span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span> </span></span> w<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span><span class="vlist-s">0</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span> L<span class="katex-html" aria-hidden="true"><span class="base"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">u</span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex">1<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">d</span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex">,<span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.1667em;"></span></span></span> v<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span></span></span></span></span></span></span> 1<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">d</span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex">)<span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2222em;"></span></span></span> +<span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1052em;vertical-align:-0.3552em;"></span> </span></span> w<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span><span class="vlist-s">1</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span> L<span class="katex-html" aria-hidden="true"><span class="base"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">u</span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex">1<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">d/2</span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span><span class="katex">,<span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.1667em;"></span></span></span> v<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span></span></span></span></span></span></span> 1<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0359em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">d/2</span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span><span class="katex">)<span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2222em;"></span></span></span> +<span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1052em;vertical-align:-0.3552em;"></span> </span></span> w<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span><span class="vlist-s">2</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span> L<span class="katex-html" aria-hidden="true"><span class="base"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">u</span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex">1<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">d/4</span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span><span class="katex">,<span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.1667em;"></span></span></span> v<span class="katex-html" aria-hidden="true"><span class="base"><span class="minner">xml-ph</span></span></span></span></p>
<p>где сумма продолжается путем вычисления потерь на половине входа в предыдущий член до тех пор, пока не будет достигнуто информационное узкое место. Авторы предлагают установить</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><annotation encoding="application/x-tex">w0=w1=⋯=1w_0=w_1=\cdots=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span></span></span></span> w<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span><span class="vlist-s">0</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span> =</span></span></span><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span> w</span></span></span><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span><span class="vlist-s">1</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span> =</span></span></span><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.3669em;"></span> ⋯</span></span></span><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2778em;"></span> =</span></span></span><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span> 1.</span></span></span></p>
<p><em>Проще говоря, потери "Матрешки" - это взвешенная сумма исходных потерь по рекурсивным подмножествам входных данных.</em></p>
<p>Один из ключевых выводов из приведенного выше уравнения заключается в том, что потери Матрешки позволяют эффективно обучать представления в нескольких масштабах за счет распределения весов между моделями встраивания (одна и та же модель используется для кодирования, например, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mn>u1</mn><mo>:</mo><mi>du_{1</mi></mrow></msub></mrow><annotation encoding="application/x-tex">:d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span></span></span></span> u <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span> 1</span></span></span></span></span></span></span></span></span> <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">d</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> и <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mn>u1</mn><mo>:</mo><mn>d/2u_{1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">:d/2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7858em;vertical-align:-0.3552em;"></span></span></span></span> u <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span> 1</span></span></span></span></span></span></span></span></span> <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">d/2</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span></span></span></span>) и совместного использования размерностей на разных масштабах<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>(</mi><mrow><mn>u1</mn><mo>:</mo><mn>d/2u_{1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">:d/2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7858em;vertical-align:-0.3552em;"></span></span></span></span> u<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span> 1</span></span></span></span></span></span></span></span></span><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">d/2</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span></span></span></span> является подмножеством <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><annotation encoding="application/x-tex">uu</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span></span></span></span> u).</p>
<h2 id="Matryoshka-Embeddings-and-Milvus" class="common-anchor-header">Матрешечные вкрапления и Milvus<button data-href="#Matryoshka-Embeddings-and-Milvus" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>Milvus без проблем поддерживает любую модель вкраплений Матрешки, которая может быть загружена через стандартные библиотеки, такие как <a href="https://milvus.io/docs/embeddings.md">pymilvus.model</a>, <a href="https://milvus.io/docs/integrate_with_sentencetransformers.md">предложения-трансформеры</a> или другие подобные инструменты. С точки зрения системы, нет никакой функциональной разницы между обычной моделью встраивания и моделью, специально обученной генерировать вкрапления "Матрешки".</p>
<p>К популярным моделям встраивания "Матрешки" относятся:</p>
<ul>
<li><p>OpenAI's <a href="https://zilliz.com/ai-models/text-embedding-3-large"><code translate="no">text-embedding-3-large</code></a></p></li>
<li><p>Nomic <a href="https://huggingface.co/nomic-ai/nomic-embed-text-v1"><code translate="no">nomic-embed-text-v1</code></a></p></li>
<li><p>модель Alibaba <a href="https://huggingface.co/Alibaba-NLP/gte-multilingual-base"><code translate="no">gte-multilingual-base</code></a></p></li>
</ul>
<p>Полное руководство по использованию вкраплений Matryoshka в Milvus можно найти в блокноте <em><a href="https://github.com/milvus-io/bootcamp/blob/master/bootcamp/tutorials/quickstart/funnel_search_with_matryoshka.ipynb">"Поиск по воронке с вкраплениями Matryoshka</a></em>".</p>
<h2 id="Summary" class="common-anchor-header">Резюме<button data-href="#Summary" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>Встраивание "Матрешки" позволяет разработчикам создавать сокращенные встраивания без ущерба для семантической целостности, что делает их идеальными для более эффективного поиска и хранения. Хотя вы можете модифицировать существующую модель, доступны и предварительно обученные варианты, например, от <a href="https://zilliz.com/ai-models">OpenAI</a> и <a href="https://zilliz.com/ai-models">Hugging Face</a>.</p>
<p>Однако в настоящее время ограничением является нехватка вкраплений "Матрешки" с открытым исходным кодом, и лишь немногие из них доступны на хабе Hugging Face. Кроме того, эти модели часто не имеют явного обозначения "Матрешка", что затрудняет их поиск. Надеемся, что с ростом интереса к ним вскоре появится более широкая доступность и более четкая маркировка.</p>
<p>Готовы оптимизировать свои поисковые возможности? Начните работу с вставками Milvus + Matryoshka уже сегодня!</p>
<h2 id="Resources" class="common-anchor-header">Ресурсы<button data-href="#Resources" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><ul>
<li><p>Блокнот: <a href="https://github.com/milvus-io/bootcamp/blob/master/bootcamp/tutorials/quickstart/funnel_search_with_matryoshka.ipynb">Поиск по воронке с помощью вкраплений Matryoshka</a></p></li>
<li><p>Документ: <a href="https://arxiv.org/abs/2205.13147">Обучение представлениям Матрешки</a></p></li>
<li><p>Документ: <a href="https://arxiv.org/pdf/2407.19669">mGTE: обобщенное представление длинноконтекстного текста и модели реранжирования для многоязычного текстового поиска</a></p></li>
<li><p><a href="https://milvus.io/blog/introducing-pymilvus-integrations-with-embedding-models.md">Интеграция PyMilvus с моделями вкраплений </a></p></li>
<li><p><a href="https://zilliz.com/learn/Exploring-BGE-M3-the-future-of-information-retrieval-with-milvus">Исследование BGE-M3: Будущее информационного поиска с помощью Milvus </a></p></li>
<li><p><a href="https://static.nomic.ai/reports/2024_Nomic_Embed_Text_Technical_Report.pdf">Nomic Embed: обучение воспроизводимого встраивателя текста с длинным контекстом</a></p></li>
<li><p><a href="https://sbert.net/examples/training/matryoshka/README.html">Обучение вкраплений "Матрешка" с помощью библиотеки Sentence Transformers</a></p></li>
<li><p><a href="https://milvus.io/bootcamp">Milvus Bootcamp</a></p></li>
</ul>
