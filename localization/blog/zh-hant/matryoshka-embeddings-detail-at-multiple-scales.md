---
id: matryoshka-embeddings-detail-at-multiple-scales
title: Matryoshka Embeddings：多尺度的細節
author: 'Stefan Webb, David Wang'
date: 2024-10-30T00:00:00.000Z
desc: 在不犧牲語意完整性的情況下，以縮短的維度進行嵌入，是更有效率的搜尋與儲存的理想選擇。
metaTitle: What are Matryoshka Embeddings?
cover: assets.zilliz.com/Introduction_to_Matryoshka_Embedding_e5a5bc2056.png
tag: Engineering
tags: Matryoshka Embeddings
recommend: true
canonicalUrl: 'https://milvus.io/blog/matryoshka-embeddings-detail-at-multiple-scales'
---
<h2 id="What-are-Matryoshka-Embeddings" class="common-anchor-header">Matryoshka Embeddings 是什麼？<button data-href="#What-are-Matryoshka-Embeddings" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>在建立有效率的<a href="https://zilliz.com/learn/vector-similarity-search">向量搜尋系統</a>時，一個主要的挑戰是管理儲存成本，同時維持可接受的延遲和召回率。現代<a href="https://zilliz.com/blog/choosing-the-right-embedding-model-for-your-data">嵌入模型</a>輸出的向量有數百或數千個維度，為原始向量和索引帶來顯著的儲存和計算開銷。</p>
<p>傳統上，我們會在建立索引之前，先應用量化或降維方法來降低儲存需求。例如，我們可以使用<a href="https://zilliz.com/learn/scalar-quantization-and-product-quantization">積量化 (Product Quantization</a>, PQ) 降低精確度，或使用主成分分析 (Principal Component Analysis, PCA) 降低維數，以節省儲存空間。這些方法會分析整個向量集，找出更精簡的向量集，以維持向量之間的語意關係。</p>
<p>這些標準方法雖然有效，但只減少一次精確度或維度，而且是在單一尺度上。但如果我們可以同時維持多層的細節，就像金字塔般越來越精確的表達，那會如何呢？</p>
<p>進入<a href="https://arxiv.org/abs/2205.13147"><strong>Matryoshka 內嵌</strong></a>。以俄羅斯嵌套娃娃命名 (見插圖)，這些聰明的結構將多層表徵嵌入單一向量中。與傳統的後處理方法不同，Matryoshka 內嵌會在初始訓練過程中學習這種多尺度結構。結果非常顯著：<strong>完整的嵌入不僅能捕捉輸入的語意，而且每個巢狀的子集前綴 (前半部、前四分之一等) 都能提供連貫的表達 (即使不那麼詳細</strong>)<strong>。</strong></p>
<p>
 <span class="img-wrapper">
   <img translate="no" src="https://assets.zilliz.com/Visualization_of_Matryoshka_embeddings_with_multiple_layers_of_detail_274f2c7aba.png" alt="Figure: Visualization of Matryoshka embeddings with multiple layers of detail" class="doc-image" id="figure:-visualization-of-matryoshka-embeddings-with-multiple-layers-of-detail" />
   <span>圖：具備多層細節的 Matryoshka 內嵌可視化</span> </span></p>
<p><em>圖具備多層細節的 Matryoshka 嵌入式可視化</em></p>
<p>這種方法與傳統的<a href="https://zilliz.com/glossary/vector-embeddings">嵌入式</a>形成強烈對比，傳統的<a href="https://zilliz.com/glossary/vector-embeddings">嵌入式</a>使用向量維度的任意子集，通常會破壞語意。有了 Matryoshka 嵌入式，您可以選擇最能平衡特定任務精確度與計算成本的粒度。</p>
<p>需要快速近似搜尋？使用最小的「娃娃」。需要最高的精確度？使用完整的嵌入。這種彈性讓它們對於要適應不同效能需求或資源限制的系統特別有價值。</p>
<h2 id="Inference" class="common-anchor-header">推論<button data-href="#Inference" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>Matryoshka 內嵌的一個重要應用是在不犧牲召回率的情況下加速相似性搜尋。透過利用查詢和資料庫內嵌的較小子集，例如其維度的前 1/32，我們可以在這個縮小的空間上建立索引，而這個索引仍然保留大部分的相似性資訊。這個較小嵌入空間的初始結果可以直接使用。不過，還有一種技術可以提升召回率，並計算出維度縮減所造成的任何輕微減少，讓這種方法對於相似性搜尋任務既有效率又有效。</p>
<p>
 <span class="img-wrapper">
   <img translate="no" src="https://assets.zilliz.com/How_the_funnel_search_works_with_Matryoshka_embeddings_8fa05a2fe7.png" alt="Figure: How the funnel search works with Matryoshka embeddings" class="doc-image" id="figure:-how-the-funnel-search-works-with-matryoshka-embeddings" />
   <span>圖：使用 Matryoshka 嵌入式的漏斗搜尋運作方式</span> </span></p>
<p><em>圖使用 Matryoshka 嵌入式的漏斗搜尋運作方式</em></p>
<p>為了在保持精確度的同時有效加快相似性搜尋的速度，我們可以使用「漏斗搜尋」的方法。首先，我們只使用嵌入維度的前 1/32 執行初始相似性搜尋，產生廣泛的候選項。然後，我們根據這些候選項與查詢的相似度，使用前 1/16 個維度來重新排序，修剪清單中的一部分。這個過程會持續反覆地進行，使用越來越大的嵌入維度子集-1/8、1/4 等等來重新排序和剪枝。重要的是，我們只在這個較低維度的空間中執行一次初始相似性搜尋，而嵌入模型的一次傳遞就能計算出查詢的嵌入。這個漏斗過程會在每一步縮小候選人的範圍，比直接在全維空間搜尋更快、更有效率。從 1/32 維空間中抽取許多匹配項目，並透過漏斗搜尋進行精煉，可以大幅加快相似性搜尋的速度，同時保留強大的召回率。</p>
<h2 id="Training" class="common-anchor-header">訓練<button data-href="#Training" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>讓我們來瞭解一些技術細節。這個方法的應用非常簡單。考慮微調<a href="https://zilliz.com/learn/what-is-bert">BERT 模型</a>以進行句子嵌入的情況。為了將已經針對掩蔽標誌損失進行預先訓練的 BERT 模型轉換為句子嵌入模型，我們將句嵌入形成為最終層的平均值，也就是每個標誌上下文化嵌入的平均值。</p>
<p>訓練目標的一種選擇是<a href="https://sbert.net/docs/package_reference/sentence_transformer/losses.html#cosentloss">Cosine Sentence (CoSENT) loss</a>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>u</mi><mo separator="true">,</mo><mi>v</mi></mrow><annotation encoding="application/x-tex">;</annotation><mrow><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord mathnormal">u</span></span></span><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><annotation encoding="application/x-tex">, v; s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span></span></span></span> L<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mopen">(</span></span></span><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span> v<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span> s<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mclose">)</span></span></span></span>。它輸入一對句子嵌入，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mo separator="true">,</mo><mi>vu</mi></mrow><annotation encoding="application/x-tex">,</annotation></semantics></math></span></span>v<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span> u</span></span></span> <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span></span></span></span> v，以及它們所需的相似性分數，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><annotation encoding="application/x-tex">ss</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span></span></span></span>s（公式請參閱上面的連結）。現在，為了學習 Matryoshka 嵌入式，我們對訓練目標做一個小小的修改：</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>LM</mi></msub><mo stretchy="false">(</mo><mi>u</mi><mo separator="true">,</mo><mi>v</mi><mo stretchy="false">)</mo><mi>=w0L</mi><mo stretchy="false">(</mo><msub><mrow><mn>u1</mn><mo>:</mo><mi>d</mi></mrow></msub><mo separator="true">,</mo><msub><mrow><mn>v1</mn><mo>:</mo><mi>d</mi></mrow></msub><msub><mrow><mi>)</mi></mrow></msub><mi>+w1L</mi><mo stretchy="false">(</mo><msub><mrow><mn>u1</mn><mo>:</mo><mn>d/2</mn></mrow></msub><mo separator="true">,</mo><msub><mrow><mn>v1</mn></mrow></msub><msub><mrow><mo>:</mo></mrow></msub><msub><mrow><mn>d/2</mn></mrow></msub><mo stretchy="false">)</mo><mi>+w2L</mi><mo stretchy="false">(</mo><msub><mrow><mn>u1</mn><mo>:</mo><mn>d/4</mn></mrow></msub><mo separator="true">,</mo><msub><mrow><mn>v1</mn><mo>:</mo><mn>d/4</mn></mrow></msub><mo stretchy="false">)</mo><mo>+⋯L_M</mo></mrow><annotation encoding="application/x-tex">(u, v) = w_0L(u_{1:d}, v_{1:d}) + w_1L(u_{1:d/2}, v_{1：</annotation></semantics></math></span></span><span class="pstrut" style="height:2.7em;"></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="strut" style="height:0.313em;"></span>d<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><annotation encoding="application/x-tex">/2}) + w_2L(u_{1:d/4}, v_{1:d/4}) + \cdots</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span></span></span>L<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span><span class="vlist-s">M</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">(u</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span></span></span>v<span class="katex-html" aria-hidden="true"><span class="base"><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span></span></span>=<span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span> </span></span>w<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span><span class="vlist-s">0</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span>L<span class="katex-html" aria-hidden="true"><span class="base"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">u</span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex">1<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">d</span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex">,<span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.1667em;"></span></span></span>v<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span></span></span></span></span></span><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">1</span></span></span></span></span></span><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">d</span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span><span class="katex">)<span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2222em;"></span></span></span>+<span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1052em;vertical-align:-0.3552em;"></span> </span></span>w<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span></span></span></span></span></span></span>1<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span>L(<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="mord mathnormal">u</span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex">1<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">d/2</span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span><span class="katex">,<span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.1667em;"></span></span></span>v<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span></span></span></span></span></span></span>1<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span></span></span></span></span></span></span></span></span><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">d/2</span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span><span class="katex">)<span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2222em;"></span></span></span>+<span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1052em;vertical-align:-0.3552em;"></span> </span></span>w<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span><span class="vlist-s">2</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span>L<span class="katex-html" aria-hidden="true"><span class="base"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">u</span></span></span></span></span><span class="pstrut" style="height:2.7em;"></span><span class="katex">1<span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">d/4</span></span></span></span></span></span></span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span><span class="katex">,<span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.1667em;"></span></span></span>v<span class="katex-html" aria-hidden="true"><span class="base"><span class="minner">xml-ph</span></span></span></span></p>
<p>其中，總和是透過計算前一個項目的一半輸入損失來繼續，直到達到資訊瓶頸為止。作者建議設定</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><annotation encoding="application/x-tex"></annotation></semantics></math></span></span><span class="strut" style="height:0.3669em;"></span>w<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><annotation encoding="application/x-tex">0=w1=⋯=1w_0=w_1=\cdots=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span></span></span></span> w<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span><span class="vlist-s">0</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span> =</span></span></span><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span> w</span></span></span><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span></span></span><span class="vlist-s">1</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"> </span></span></span></span>=<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2778em;"></span> ⋯</span></span></span><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2778em;"></span> =</span></span></span><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span></span><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">1</span></span></span></span></span></span></span></span>。</p>
<p><em>簡單來說，Matryoshka 損失是原始損失在輸入的遞歸子集中的加權總和。</em></p>
<p>從上面等式中得到的一個關鍵啟示是，Matryoshka 損失通過在嵌入模型之間共享權重，實現了多尺度表徵的高效學習（同一模型用於編碼，例如<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mn>u1</mn><mo>：</mo></mrow></msub></mrow><annotation encoding="application/x-tex">du_{1:</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist-s">d}</span></span></span></span></span><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"></span></span></span></span>u<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span> 1</span></span></span></span></span></span></span></span></span> <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">d</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mn>u1</mn><mo>:</mo><mn>d/2u_{1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">:</annotation><mrow><msub><mrow><mi>d/2}</mi></mrow></msub></mrow></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7858em;vertical-align:-0.3552em;"></span></span></span></span> u<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span> 1</span></span></span></span></span></span></span></span></span> <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span></span></span></span></span></span></span></span></span></span></span></span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi>d/2</mi></mrow></msub></mrow></semantics></math></span></span> <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span></span></span></span> ）和跨尺度共享維度<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>（</mi></msub></mrow></semantics></math></span></span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u1</mi></mrow></semantics></math></span></span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><annotation encoding="application/x-tex">:</annotation></semantics></math></span></span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi>d/2u_{</mi></mrow></msub></mrow></semantics></math></span></span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><annotation encoding="application/x-tex">1:d</annotation></semantics></math></span></span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi>/2</mi></mrow></msub></mrow></semantics></math></span></span>}<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7858em;vertical-align:-0.3552em;"></span> u</span></span></span><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span> 1</span></span></span></span></span></span></span></span></span><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord"><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span></span></span></span></span><span class="vlist-s">d/2</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span></span></span></span>是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><annotation encoding="application/x-tex">uu</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span></span></span></span> u 的子集）。</p>
<h2 id="Matryoshka-Embeddings-and-Milvus" class="common-anchor-header">Matryoshka 嵌入與 Milvus<button data-href="#Matryoshka-Embeddings-and-Milvus" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>Milvus 無縫支援任何 Matryoshka 嵌入模型，這些模型可以透過標準函式庫，例如<a href="https://milvus.io/docs/embeddings.md">pymilvus.model</a>、<a href="https://milvus.io/docs/integrate_with_sentencetransformers.md">句子轉換器</a>或其他類似的工具載入。從系統的角度來看，一般的嵌入模型與特別訓練來產生 Matryoshka 嵌入的模型在功能上沒有任何差異。</p>
<p>受歡迎的 Matryoshka 嵌入模型包括</p>
<ul>
<li><p>OpenAI 的 <a href="https://zilliz.com/ai-models/text-embedding-3-large"><code translate="no">text-embedding-3-large</code></a></p></li>
<li><p>Nomic 的 <a href="https://huggingface.co/nomic-ai/nomic-embed-text-v1"><code translate="no">nomic-embed-text-v1</code></a></p></li>
<li><p>阿里巴巴的 <a href="https://huggingface.co/Alibaba-NLP/gte-multilingual-base"><code translate="no">gte-multilingual-base</code></a></p></li>
</ul>
<p>有關在 Milvus 中使用 Matryoshka 嵌入模型的完整指南，請參閱筆記型<em><a href="https://github.com/milvus-io/bootcamp/blob/master/bootcamp/tutorials/quickstart/funnel_search_with_matryoshka.ipynb">電腦 Funnel Search with Matryoshka Embeddings</a></em>。</p>
<h2 id="Summary" class="common-anchor-header">摘要<button data-href="#Summary" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><p>Matryoshka embedding 可讓開發人員在不犧牲語意完整性的情況下建立縮短的 embeddings，使其成為更有效率的搜尋與儲存的理想選擇。您可以修改現有的模型，也可以使用預先訓練的選項，例如<a href="https://zilliz.com/ai-models">OpenAI</a>和<a href="https://zilliz.com/ai-models">Hugging Face</a> 提供的選項。</p>
<p>然而，目前的限制在於開放原始碼的 Matryoshka 內嵌模型非常稀少，在 Hugging Face hub 上幾乎找不到。此外，這些模型通常沒有明確標示為「Matryoshka」，因此較難找到。希望隨著興趣的增加，更廣泛的可用性和更明確的標籤可能很快就會出現。</p>
<p>準備好簡化您的搜尋能力了嗎？立即開始使用 Milvus + Matryoshka 嵌入式！</p>
<h2 id="Resources" class="common-anchor-header">資源<button data-href="#Resources" class="anchor-icon" translate="no">
      <svg translate="no"
        aria-hidden="true"
        focusable="false"
        height="20"
        version="1.1"
        viewBox="0 0 16 16"
        width="16"
      >
        <path
          fill="#0092E4"
          fill-rule="evenodd"
          d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"
        ></path>
      </svg>
    </button></h2><ul>
<li><p>筆記本：<a href="https://github.com/milvus-io/bootcamp/blob/master/bootcamp/tutorials/quickstart/funnel_search_with_matryoshka.ipynb">使用 Matryoshka 嵌入式進行漏斗搜尋</a></p></li>
<li><p>論文：<a href="https://arxiv.org/abs/2205.13147">Matryoshka 表示學習</a></p></li>
<li><p>論文：<a href="https://arxiv.org/pdf/2407.19669">mGTE：用於多語言文本檢索的通用長上下文文本表示和重排模型</a></p></li>
<li><p><a href="https://milvus.io/blog/introducing-pymilvus-integrations-with-embedding-models.md">介紹 PyMilvus 與嵌入模型的整合 </a></p></li>
<li><p><a href="https://zilliz.com/learn/Exploring-BGE-M3-the-future-of-information-retrieval-with-milvus">探索 BGE-M3：使用 Milvus 進行資訊檢索的未來 </a></p></li>
<li><p><a href="https://static.nomic.ai/reports/2024_Nomic_Embed_Text_Technical_Report.pdf">Nomic Embed：訓練可重複的長內文文字嵌入器</a></p></li>
<li><p><a href="https://sbert.net/examples/training/matryoshka/README.html">使用 Sentence Transformers Library 訓練 Matryoshka Embeddings</a></p></li>
<li><p><a href="https://milvus.io/bootcamp">Milvus Bootcamp</a></p></li>
</ul>
